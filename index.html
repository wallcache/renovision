<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Renovision. A Doer-Upper's Best Friend.</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="apple-touch-icon" href="assets/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <script>
    // Tailwind config must be defined before the CDN script loads
    window.tailwind = {
      config: {
        theme: {
          extend: {
            fontFamily: {
              serif: ['Cormorant Garamond', 'Georgia', 'serif'],
              sans: ['Inter', 'system-ui', 'sans-serif'],
            },
            colors: {
              linen: {
                50: '#fdfcfb',
                100: '#faf8f4',
                200: '#f2efe9',
                300: '#e8e4dc',
                400: '#d4cfc4',
                500: '#b8b1a4',
                600: '#a89f93',
                700: '#8a8278',
                800: '#6b655c',
                900: '#2c2c2c',
              },
              taupe: {
                light: '#c4bbb0',
                DEFAULT: '#a89f93',
                dark: '#8a8278',
              },
              sage: {
                light: '#d4ddd4',
                DEFAULT: '#9aab9a',
                dark: '#7a8f7a',
              },
              clay: {
                light: '#e8d8cc',
                DEFAULT: '#c9a88a',
                dark: '#a68b6a',
              }
            }
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #faf8f4;
      color: #2c2c2c;
      min-height: 100vh;
    }
    
    .font-serif {
      font-family: 'Cormorant Garamond', Georgia, serif;
    }
    
    /* Subtle linen texture */
    .linen-texture {
      background-image: 
        linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%),
        url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.02'/%3E%3C/svg%3E");
    }
    
    /* Card styles */
    .card {
      background: linear-gradient(145deg, #fdfcfb 0%, #f8f6f2 100%);
      border: 1px solid rgba(168, 159, 147, 0.15);
      box-shadow: 
        0 1px 3px rgba(0, 0, 0, 0.04),
        0 4px 12px rgba(0, 0, 0, 0.02);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.06),
        0 8px 24px rgba(0, 0, 0, 0.04);
      border-color: rgba(168, 159, 147, 0.3);
    }
    
    /* Image card selection */
    .image-card {
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .image-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, transparent 60%, rgba(44, 44, 44, 0.4) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .image-card:hover::after {
      opacity: 1;
    }
    
    .image-card:hover {
      transform: scale(1.02);
    }
    
    .image-card:hover .select-hint {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Toggle pill buttons */
    .toggle-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .toggle-pill {
      padding: 0.625rem 1.25rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 400;
      background: #f2efe9;
      border: 1px solid rgba(168, 159, 147, 0.2);
      color: #6b655c;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle-pill:hover {
      background: #e8e4dc;
      border-color: rgba(168, 159, 147, 0.4);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .toggle-pill:active {
      transform: scale(0.97);
    }

    .toggle-pill.active {
      background: #2c2c2c;
      border-color: #2c2c2c;
      color: #faf8f4;
    }

    /* Accordion toggle groups */
    .toggle-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #f8f6f2;
      border-radius: 0.75rem;
      cursor: pointer;
      margin-bottom: 0.5rem;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle-group-header:hover {
      background: #f2efe9;
    }

    .toggle-group-header .chevron {
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      color: #a89f93;
    }

    .toggle-group-header.expanded .chevron {
      transform: rotate(180deg);
    }

    .toggle-group-content {
      overflow: hidden;
      transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle-group-content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    .toggle-group-content.expanded {
      max-height: 600px;
      opacity: 1;
      padding-bottom: 1rem;
    }
    
    /* Button styles */
    .btn-primary {
      background: #2c2c2c;
      color: #faf8f4;
      border: none;
      border-radius: 9999px;
      padding: 1rem 2rem;
      font-weight: 500;
      transition: all 0.25s ease;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #1a1a1a;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(44, 44, 44, 0.15);
    }
    
    .btn-primary:disabled {
      background: #d4cfc4;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: transparent;
      color: #6b655c;
      border: 1px solid rgba(168, 159, 147, 0.3);
      border-radius: 9999px;
      padding: 0.875rem 1.75rem;
      font-weight: 400;
      transition: all 0.25s ease;
    }
    
    .btn-secondary:hover {
      background: #f2efe9;
      border-color: rgba(168, 159, 147, 0.5);
    }
    
    /* Input styles */
    .input-field {
      background: #fdfcfb;
      border: 1px solid rgba(168, 159, 147, 0.25);
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      font-size: 0.9375rem;
      color: #2c2c2c;
      transition: all 0.25s ease;
      width: 100%;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #a89f93;
      box-shadow: 0 0 0 3px rgba(168, 159, 147, 0.1);
    }
    
    .input-field::placeholder {
      color: #b8b1a4;
      opacity: var(--placeholder-opacity, 1);
      transition: opacity 0.3s ease-out;
    }

    .input-field::-webkit-input-placeholder {
      opacity: var(--placeholder-opacity, 1);
      transition: opacity 0.3s ease-out;
    }

    .input-field::-moz-placeholder {
      opacity: var(--placeholder-opacity, 1);
      transition: opacity 0.3s ease-out;
    }

    .input-field:-ms-input-placeholder {
      opacity: var(--placeholder-opacity, 1);
      transition: opacity 0.3s ease-out;
    }
    
    /* Comparison slider */
    .comparison-slider {
      position: relative;
      overflow: hidden;
      cursor: ew-resize;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: none;
      -webkit-touch-callout: none;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    .comparison-slider img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
    }

    .comparison-after {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .comparison-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #faf8f4;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }
    
    .comparison-grip {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 44px;
      height: 44px;
      background: #faf8f4;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    .loading-pulse {
      animation: pulse 2s ease-in-out infinite;
    }

    /* Organic blob rotation animation */
    @keyframes rotate-blob {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .rotating-blob {
      animation: rotate-blob 3s linear infinite;
    }
    
    /* Fade animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    /* Checkbox toggle */
    .toggle-checkbox {
      position: relative;
      width: 48px;
      height: 28px;
      background: #e8e4dc;
      border-radius: 9999px;
      cursor: pointer;
      transition: background 0.25s ease;
    }
    
    .toggle-checkbox.active {
      background: #2c2c2c;
    }
    
    .toggle-checkbox::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: #fdfcfb;
      border-radius: 50%;
      transition: transform 0.25s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .toggle-checkbox.active::after {
      transform: translateX(20px);
    }
    
    /* Logo */
    .logo-img {
      height: 56px;
      width: auto;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f2efe9;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #d4cfc4;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #b8b1a4;
    }
  </style>
</head>
<body class="min-h-screen linen-texture">
  <div id="root"></div>

  <!-- Clerk Authentication SDK -->
  <script>
    console.log('[Clerk] üîÑ Starting to load Clerk SDK from CDN...');
    console.log('[Clerk] Timestamp:', new Date().toISOString());
    console.log('[Clerk] Navigator online:', navigator.onLine);

    // Fallback CDN loading strategy
    window.clerkLoadAttempts = 0;
    window.clerkCDNs = [
      'https://cdn.jsdelivr.net/npm/@clerk/clerk-js@5/dist/clerk.browser.js',
      'https://unpkg.com/@clerk/clerk-js@5/dist/clerk.browser.js',
      'https://cdn.jsdelivr.net/npm/@clerk/clerk-js@4/dist/clerk.browser.js'
    ];

    function loadClerkScript(cdnUrl, retryIndex) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.id = 'clerk-sdk-script';
        script.src = cdnUrl;
        script.crossOrigin = 'anonymous';
        script.setAttribute('data-clerk-publishable-key', 'pk_test_YnVyc3RpbmctcHVnLTUyLmNsZXJrLmFjY291bnRzLmRldiQ');

        script.onload = () => {
          console.log('[Clerk] ‚úÖ SDK loaded successfully from:', cdnUrl);
          console.log('[Clerk] window.Clerk type:', typeof window.Clerk);
          resolve();
        };

        script.onerror = () => {
          console.error('[Clerk] ‚ùå Failed to load from:', cdnUrl);
          document.head.removeChild(script);

          // Try next CDN
          if (retryIndex < window.clerkCDNs.length - 1) {
            console.log('[Clerk] üîÑ Trying next CDN...');
            loadClerkScript(window.clerkCDNs[retryIndex + 1], retryIndex + 1)
              .then(resolve)
              .catch(reject);
          } else {
            reject(new Error('All CDN sources failed'));
          }
        };

        document.head.appendChild(script);
      });
    }

    // Start loading from first CDN
    loadClerkScript(window.clerkCDNs[0], 0).catch(err => {
      console.error('[Clerk] ‚ùå All CDN attempts failed:', err);
      console.error('[Clerk] üí° Please check your internet connection and try again later');
    });
  </script>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============================================
    // CONFIGURATION
    // ============================================
    
    const API_BASE_URL = 'https://renovision-5z2b.onrender.com';
    const LOGO_URL = 'assets/logo.png';
    
    // Toggle options
    const DESIGN_STYLE_OPTIONS = [
      { id: 'english_contemporary', label: 'English Contemporary' },
      { id: 'modern_organic', label: 'Modern Organic' },
      { id: 'scandinavian_minimalism', label: 'Scandinavian Minimalism' },
      { id: 'japandi', label: 'Japandi' },
      { id: 'parisian_classic', label: 'Parisian Classic' },
      { id: 'coastal_elevated', label: 'Coastal Elevated' },
      { id: 'midcentury_modern', label: 'Mid-Century Modern' },
      { id: 'moody_contemporary', label: 'Moody Contemporary' },
      { id: 'rustic_modern', label: 'Rustic Modern' },
    ];

    const ROOM_TYPE_OPTIONS = [
      { id: 'living', label: 'Living' },
      { id: 'bedroom', label: 'Bedroom' },
      { id: 'kitchen', label: 'Kitchen' },
      { id: 'dining', label: 'Dining' },
      { id: 'bathroom', label: 'Bathroom' },
      { id: 'office', label: 'Office' },
      { id: 'hallway', label: 'Hallway' },
      { id: 'garden', label: 'Garden' },
      { id: 'outdoor', label: 'Outdoor' },
    ];

    const TIME_OF_DAY_OPTIONS = [
      { id: 'day', label: 'Day' },
      { id: 'night', label: 'Night' },
      { id: 'golden_hour', label: 'Golden Hour' },
    ];

    const COLOUR_SCHEME_OPTIONS = [
      // Neutrals & Whites
      { id: 'soft_linen', label: 'Soft Linen', swatch: '#FAF8F4' },
      { id: 'cream_core', label: 'Cream Core', swatch: '#F5F0E6' },
      { id: 'nordic_mist', label: 'Nordic Mist', swatch: '#E8E8E8' },
      { id: 'warm_grey', label: 'Warm Grey', swatch: '#B8AFA4' },
      { id: 'charcoal', label: 'Charcoal', swatch: '#3D3D3D' },

      // Reds & Pinks
      { id: 'burgundy_depth', label: 'Burgundy Depth', swatch: '#722F37' },
      { id: 'crimson_red', label: 'Crimson Red', swatch: '#DC143C' },
      { id: 'blush_pink', label: 'Blush Pink', swatch: '#F8C8DC' },
      { id: 'dusty_rose', label: 'Dusty Rose', swatch: '#C9A9A6' },

      // Oranges & Corals
      { id: 'terracotta_sun', label: 'Terracotta Sun', swatch: '#C67D5E' },
      { id: 'burnt_orange', label: 'Burnt Orange', swatch: '#CC5500' },
      { id: 'coral_reef', label: 'Coral Reef', swatch: '#FF7F50' },

      // Yellows & Golds
      { id: 'amber_glow', label: 'Amber Glow', swatch: '#FFBF00' },
      { id: 'sunshine_yellow', label: 'Sunshine Yellow', swatch: '#FFD700' },
      { id: 'mustard', label: 'Mustard', swatch: '#E1AD01' },

      // Greens
      { id: 'sage_calm', label: 'Sage Calm', swatch: '#9CAF88' },
      { id: 'olive_grove', label: 'Olive Grove', swatch: '#708238' },
      { id: 'forest_green', label: 'Forest Green', swatch: '#228B22' },
      { id: 'emerald', label: 'Emerald', swatch: '#50C878' },

      // Blues
      { id: 'midnight_blue', label: 'Midnight Blue', swatch: '#191970' },
      { id: 'sky_blue', label: 'Sky Blue', swatch: '#87CEEB' },
      { id: 'teal', label: 'Teal', swatch: '#008080' },
      { id: 'navy', label: 'Navy', swatch: '#000080' },

      // Purples & Violets
      { id: 'lavender', label: 'Lavender', swatch: '#B19CD9' },
      { id: 'plum', label: 'Plum', swatch: '#8E4585' },
      { id: 'aubergine', label: 'Aubergine', swatch: '#3B2F2F' },
    ];

    const FLOORING_OPTIONS = [
      { id: 'wood_parquet', label: 'Wood Parquet' },
      { id: 'tiled', label: 'Tiled' },
      { id: 'stone_slabs', label: 'Stone Slabs' },
      { id: 'polished_concrete', label: 'Polished Concrete' },
      { id: 'carpetted', label: 'Carpetted' },
    ];

    const WALLPAPER_OPTIONS = [
      { id: 'none', label: 'No Wallpaper' },
      { id: 'floral', label: 'Floral Wallpaper' },
      { id: 'geometric', label: 'Geometric Wallpaper' },
      { id: 'striped', label: 'Striped Wallpaper' },
      { id: 'damask', label: 'Damask Wallpaper' },
      { id: 'botanical', label: 'Botanical Wallpaper' },
    ];

    const GARDEN_STYLE_OPTIONS = [
      { id: 'english_cottage', label: 'English Cottage Garden', description: 'Romantic, abundant, joyfully messy in the best way. Expect to find: billowing mixed borders of roses, lavender, foxgloves and delphiniums, winding paths, climbing plants over arches or pergolas, hidden benches, and a gentle "just discovered this" feel everywhere.' },
      { id: 'naturalistic_meadow', label: 'Naturalistic / Meadow Garden', description: 'Calm, modern-wild, and nature-led. Expect to find: informal drifts of grasses and perennial wildflowers, sweeping planting that changes seasonally, soft curving mow paths, wildlife ponds, and a feeling of serene movement through open space.' },
      { id: 'modern_contemporary', label: 'Modern / Contemporary Garden', description: 'Clean, sculptural, and confident. Expect to find: sharp lines and clear geometry, large-format paving or decking, raised planters, limited plant palettes (like grasses or acers), water features, outdoor lounges, and dramatic evening lighting.' },
      { id: 'japanese', label: 'Japanese Garden', description: 'Quietly spiritual, precise without being stiff. Expect to find: stone paths, stepping stones, clipped junipers or pines, mossy ground cover, gravel gardens, reflecting ponds, lanterns, and framed viewpoints designed to guide calm contemplation.' },
      { id: 'mediterranean', label: 'Mediterranean Garden', description: 'Sun-bleached, relaxed, permanently on holiday. Expect to find: olive or fig trees, lavender and rosemary, gravel groundcover, terracotta pots, stone walls, water bowls, shaded dining pergolas, and planting designed for drought tolerance.' },
      { id: 'woodland', label: 'Woodland Garden', description: 'Enclosed, textural, and deeply atmospheric. Expect to find: mature trees creating dappled shade, layers of ferns and hostas, meandering bark paths, natural stone seating, hellebores and spring bulbs, and pockets that feel like secret hideaways.' },
      { id: 'urban_courtyard', label: 'Urban Courtyard Garden', description: 'Small-space sophistication with attitude. Expect to find: vertical planting, climbers on walls, container cluster arrangements, paved floors softened by greenery, bistro or lounge seating, mirrors for depth, and clever lighting for nighttime drama.' },
      { id: 'wildlife_pollinator', label: 'Wildlife / Pollinator Garden', description: 'Buzzing, soulful, life-first design. Expect to find: wildflower meadows, mixed hedgerows, ponds, log piles, insect hotels, seed-rich planting, unmanicured corners, and a layout that trades rigid tidiness for living abundance.' },
    ];

    const LOADING_MESSAGES = [
      "Overshooting the budget...",
      "Knocking through a wall or two...",
      "Arguing with the listed building officer...",
      "Convincing the neighbours about the extension...",
      "Sourcing reclaimed victorian floorboards...",
      "Haggling at the antique market...",
      "Pretending to understand load-bearing walls...",
      "Googling 'is farrow & ball worth it'...",
      "Adding another velvet sofa...",
      "Removing the previous owner's wallpaper choices...",
      "Manifesting off-street parking...",
      "Installing underfloor heating retrospectively...",
      "Finding a builder who'll actually call back...",
      "Justifying the statement pendant light...",
      "Hiding the boiler somewhere clever...",
      "Making the most of the 'cosy' proportions...",
      "Explaining 'open-plan living' to a 1930s semi...",
      "Choosing between hague blue and stiffkey blue...",
      "Measuring twice, cutting once...",
      "Persuading the mortgage lender it's 'characterful'...",
      "Adding a boot room no one asked for...",
      "Squeezing in a downstairs loo...",
      "Deciding the kitchen island is non-negotiable...",
      "Imagining what 'good bones' actually means...",
      "Desperately re-aligning the sofa with better chi...",
      "Squinting past the fisheye lens distortion...",
      "Translating 'cosy' into square-foot reality...",
      "Blaming bad layouts on blocked qi...",
      "Counting plug sockets like it's a sport...",
      "Deciding that moving one door could heal everything...",
      "Mentally removing decades of bad laminate...",
      "Diagnosing 'stagnant energy' in windowless toilets...",
      "Arguing if the staircase is stealing our fortune luck...",
      "Negotiating with ourselves about ceiling heights...",
      "Measuring imaginary islands in tiny kitchens...",
      "Declaring open-plan chaos 'energetically aggressive'...",
      "Deleting virtual feature walls aggressively...",
      "Re-aligning bed placement for maximum dream potency...",
      "Judging the stairs for creak potential...",
      "Worrying the front door doesn't welcome prosperity properly...",
      "Deciding which walls are emotionally load-bearing...",
      "Calculating skylight-to-daylight ratios...",
      "Imagining plants where carpets fear to tread...",
      "Dreaming of underfloor heating while standing on lino...",
      "Rotating sofas that don't exist yet...",
      "Checking sightlines for the perfect morning coffee spot...",
      "Plotting the demise of the shower-over-bath...",
      "Evaluating whether a utility room is a personality trait...",
      "Removing fake beams with violent enthusiasm...",
      "Stepping over estate agent zoom blur...",
      "Prosecuting the layout for crimes against flow...",
      "Re-routing imaginary plumbing with confidence...",
      "Removing chimney breasts in our minds already...",
      "Visualising a reading nook in the smallest corner possible...",
      "Converting box rooms into 'studios' (emotionally)...",
      "Playing 'wall or structural column?' roulette...",
      "Forecasting how many skips we'll need...",
      "Assigning vibes to rooms we haven't built yet...",
      "Questioning every randomly placed radiator...",
      "Planning dramatic pendant lighting moments...",
      "Working out if that alcove could house a wine fridge...",
      "Rewriting 'unique layout' as 'chaotic geometry'...",
      "Mentally widening hallways with sheer willpower...",
      "Test-fitting future christmas trees into odd rooms...",
    ];

    const HOMEPAGE_HEADLINES = [
      "See What This Place Could Become.",
      "Discover What's Possible.",
      "Find The Beauty In The Bones.",
      "Every Room Has A Second Act.",
      "Potential, Revealed.",
      "Look Past The Artex.",
      "See Beyond The Magnolia.",
      "Ignore The Carpets. We Did.",
      "That Wallpaper Won't Be There Long.",
      "Underneath That Avocado Bathroom...",
      "What If The Previous Owners Had Taste?",
      "A Doer-Upper's Best Friend.",
      "For Those Who See Past The Photos.",
      "Renovate Before You Buy.",
      "Your Architect's First Draft.",
      "Skip The Guesswork.",
      "See The Finish Line First.",
      "Where Imagination Meets Square Footage.",
      "Turn 'It Has Potential' Into Proof.",
      "Make The Estate Agent's Lies Come True.",
      "Because 'Needs Updating' Means Opportunity.",
      "Visualise The Potential.",
    ];

    const HOMEPAGE_SUBTITLES = [
      "Drop a property link and let possibility take centre stage.",
      "Paste a link, and watch potential unfurl like a well-cut curtain.",
      "Enter a property link, and behold the drama of what could be.",
      "Share a link, and let imagination do the heavy lifting.",
      "Paste a property, and let opportunity strike a pose.",
      "Submit a link, and watch ordinary rooms learn extraordinary tricks.",
      "Give us a link, and let potential have its moment in the spotlight.",
    ];

    const EXTRA_NOTES_PLACEHOLDERS = [
      "Pop a Keith Haring on that wall, your sofa will thank you...",
      "A Togo in neon orange might clash gloriously with that rug...",
      "Imagine a Labradoodle sprawled on the velvet armchair...",
      "Maybe a gold-trimmed mirror that makes your hallway look heroic...",
      "Hang a disco ball above the kitchen island, why not...",
      "Scatter cushions like confetti on the sofa, bold and unapologetic...",
      "A stack of mid-century coffee table books, just begging to be spilled...",
      "Put a tiny cactus army on the windowsill...",
      "Maybe a velvet pouf where nobody will sit but it looks fabulous...",
      "Brass taps in the kitchen that scream, \"I'm worth it\"...",
      "A neon sign saying \"Dinner Served?\" above the stove...",
      "A potted palm in the corner like it owns the place...",
      "Add a geometric rug so sharp it could cut feelings...",
      "A vintage record player with jazz spilling like spilled wine...",
      "A framed dog portrait, bonus points if it's wearing sunglasses...",
      "Floor cushions in crazy prints for impromptu dance-offs...",
      "A statement pendant light that doubles as a conversation starter...",
      "Some mismatched chairs around the table, chaos looks chic...",
      "A little gold statue that nobody knows the origin of...",
      "Hang a map with pins where you've never been...",
      "A velvet headboard so dramatic it deserves its own theme song...",
      "A neon flamingo lamp because subtle is overrated...",
      "A beanbag in the reading nook for dramatic lounging...",
      "An oversized clock that looks like it belongs in a Wes Anderson film...",
      "Throw in a basket of ridiculously fluffy throws, because why not...",
      "A single monstera leaf in a glass vase, majestically lonely...",
      "A tiny dog bowl in designer chic, just for laughs...",
      "A coffee table that doubles as a mini gallery of oddities...",
      "A bright wallpaper corner no one can resist photographing...",
      "A chandelier above the bed for your inner royalty to thrive...",
      "Imagine a velvet chaise for napping while pondering the futility of existence...",
      "A gilt-framed portrait of a cat judging your life choices...",
      "Scatter books like breadcrumbs, leading to some secret philosophical revelation...",
      "A single candle burning next to a half-empty glass of wine...",
      "An antique globe with pins in countries you've only dreamed of visiting...",
      "A brass telescope pointing out the window to nowhere in particular...",
      "A velvet footstool that doubles as a throne for your inner aristocrat...",
      "A neon sign that says \"Why Not?\" blinking at random intervals...",
      "A Labrador in a cashmere sweater lying on a Persian rug...",
      "A chandelier so flamboyant it demands applause from the furniture...",
      "A tiny bonsai in the corner contemplating its own mortality...",
      "A Togo sofa in shocking pink, unapologetically clashing with the walls...",
      "Floor cushions arranged like they've hosted secret salons...",
      "A golden pineapple that refuses to be ignored...",
      "A fireplace mantel decorated with absurdly ornate clocks ticking at their own pace...",
      "A throw so fluffy it could smother small existential dread...",
      "A single, dramatic velvet curtain blowing slightly, as if sighing...",
      "A vintage gramophone playing jazz only when nobody is looking...",
      "A coffee table with a hidden drawer full of scandalous secrets...",
      "A staircase lined with tiny portraits of eccentric ancestors...",
      "A teacup on a saucer perched precariously, like a statement of rebellion...",
      "A massive potted palm pretending it owns the room...",
      "An oversized mirror angled to reflect all the wrong angles beautifully...",
      "A single pendant light casting shadows that look suspiciously like dancing...",
      "A rug that seems to whisper \"sit here, contemplate life\"...",
      "A stack of mismatched cushions that would survive the apocalypse...",
      "A tiny sculpture holding a wine glass, silently judging guests...",
      "A velvet armchair that looks cozy but only for aristocrats or poets...",
      "A floor lamp bending slightly as if bowing in reverence...",
      "A faint smell of old books and chocolate drifting from nowhere...",
      "A vintage typewriter on the desk with a half-written letter stuck in it...",
      "A collection of succulents arranged like tiny architectural models...",
      "A brass bar cart stocked with decanters that catch the light beautifully...",
      "A Persian rug that's seen better days but tells better stories...",
      "A window seat piled with cushions begging for afternoon naps...",
      "A gallery wall of black and white photographs in mismatched frames...",
      "A freestanding bathtub positioned for optimal daydreaming...",
      "A kitchen island with stools that make you want to linger over coffee...",
      "A reading lamp angled perfectly for late-night page turning...",
      "A collection of vintage cameras displayed like sculpture...",
      "A velvet ottoman in an impractical but gorgeous jewel tone...",
      "A marble coffee table that doubles as an altar to good taste...",
      "A macram√© wall hanging that somehow doesn't look like 1970s suburbia...",
      "A fireplace mantel styled with candlesticks and curiosities...",
      "A brass umbrella stand that's never actually held an umbrella...",
      "A library ladder on rails because why not live the fantasy...",
      "A drinks trolley with vintage glassware catching rainbow light...",
      "A statement armchair in burnt orange that demands attention...",
      "A collection of art books stacked horizontally as accent pieces...",
      "A terrarium ecosystem thriving in a glass cloche...",
      "A vintage mirror with foxed glass adding character to every reflection...",
      "A daybed piled with throws for maximum lounging potential...",
      "A kitchen shelf displaying colorful Le Creuset like a rainbow...",
      "A brass desk lamp with a green shade giving off detective novel vibes...",
      "A ceramic garden stool doubling as a side table because versatility...",
      "A collection of vintage botanical prints in gilt frames...",
      "A sheepskin throw draped artfully over the back of a chair...",
      "A bar of brass picture lights illuminating imaginary masterpieces...",
      "A vintage globe showing countries that no longer exist...",
      "A ceramic vase collection in graduated heights creating rhythm...",
      "A stack of vintage suitcases repurposed as quirky storage...",
      "A brass tension rod with plants cascading down like a living curtain...",
      "A mid-century credenza hiding all the chaos inside its sleek doors...",
      "A collection of brass candlesticks in varying heights for drama...",
      "A vintage apothecary cabinet with tiny drawers full of mysteries...",
      "A sheepskin rug making even cold floors feel inviting...",
      "A drinks tray on the coffee table suggesting sophisticated evenings ahead...",
    ];

    // ============================================
    // CLERK AUTHENTICATION SETUP
    // ============================================

    const CLERK_PUBLISHABLE_KEY = 'pk_test_YnVyc3RpbmctcHVnLTUyLmNsZXJrLmFjY291bnRzLmRldiQ';

    // Initialize Clerk
    let clerkInstance = null;
    let clerkLoaded = false;

    // Load Clerk asynchronously (lazy load - only needed when generating)
    async function ensureClerkLoaded() {
      if (clerkLoaded && clerkInstance) {
        console.log('[Clerk] ‚ôªÔ∏è  Using cached Clerk instance');
        return clerkInstance;
      }

      try {
        console.log('[Clerk] üîê Initializing authentication...');
        console.log('[Clerk] Checking for window.Clerk availability...');

        // Wait for Clerk SDK to be available with timeout
        let attempts = 0;
        const maxAttempts = 50;
        console.log('[Clerk] Will check up to', maxAttempts, 'times (5 seconds total)');

        while (!window.Clerk && attempts < maxAttempts) {
          if (attempts % 10 === 0) {
            console.log(`[Clerk] ‚è≥ Waiting for SDK... (attempt ${attempts}/${maxAttempts})`);
          }
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }

        console.log(`[Clerk] Finished waiting after ${attempts} attempts (${attempts * 100}ms)`);

        if (!window.Clerk) {
          console.error('[Clerk] ‚ùå window.Clerk is still undefined after waiting');
          console.error('[Clerk] Available window properties:', Object.keys(window).filter(k => k.toLowerCase().includes('clerk')));

          // Check if script loaded
          const scriptEl = document.getElementById('clerk-sdk-script');
          if (scriptEl) {
            console.error('[Clerk] Script element info:');
            console.error('  - src:', scriptEl.src);
            console.error('  - readyState:', scriptEl.readyState);
          }

          throw new Error('Clerk SDK failed to load from CDN. Please check your internet connection and try again.');
        }

        console.log('[Clerk] ‚úÖ window.Clerk found! Type:', typeof window.Clerk);
        console.log('[Clerk] window.Clerk properties:', Object.keys(window.Clerk || {}));
        console.log('[Clerk] Is constructor:', typeof window.Clerk === 'function');
        console.log('[Clerk] window.Clerk:', window.Clerk);

        // Verify publishable key
        console.log('[Clerk] Verifying publishable key...');
        console.log('[Clerk] Key length:', CLERK_PUBLISHABLE_KEY ? CLERK_PUBLISHABLE_KEY.length : 0);
        console.log('[Clerk] Key starts with:', CLERK_PUBLISHABLE_KEY ? CLERK_PUBLISHABLE_KEY.substring(0, 15) : 'undefined');

        if (!CLERK_PUBLISHABLE_KEY || CLERK_PUBLISHABLE_KEY === 'pk_test_YnVyc3RpbmctcHVnLTUyLmNsZXJrLmFjY291bnRzLmRldiQ') {
          console.warn('[Clerk] ‚ö†Ô∏è  Using default/placeholder publishable key. Please update with your own key.');
        }

        console.log('[Clerk] Initializing Clerk instance...');

        // Try different initialization methods based on SDK version
        if (typeof window.Clerk === 'function') {
          // Constructor method (v4 and earlier)
          console.log('[Clerk] Using constructor method: new window.Clerk()');
          clerkInstance = new window.Clerk(CLERK_PUBLISHABLE_KEY);
          await clerkInstance.load();
        } else if (window.Clerk && typeof window.Clerk.load === 'function') {
          // Direct load method (v5+)
          console.log('[Clerk] Using direct load method: window.Clerk.load()');
          await window.Clerk.load({ publishableKey: CLERK_PUBLISHABLE_KEY });
          clerkInstance = window.Clerk;
        } else if (window.Clerk && window.Clerk.default) {
          // ES Module default export
          if (typeof window.Clerk.default === 'function') {
            console.log('[Clerk] Using default export constructor');
            clerkInstance = new window.Clerk.default(CLERK_PUBLISHABLE_KEY);
            await clerkInstance.load();
          } else if (typeof window.Clerk.default.load === 'function') {
            console.log('[Clerk] Using default export load method');
            await window.Clerk.default.load({ publishableKey: CLERK_PUBLISHABLE_KEY });
            clerkInstance = window.Clerk.default;
          }
        } else {
          console.error('[Clerk] Available methods:', Object.keys(window.Clerk || {}));
          throw new Error('Unable to determine correct Clerk initialization method. window.Clerk type: ' + typeof window.Clerk);
        }

        console.log('[Clerk] Clerk instance loaded successfully');

        clerkLoaded = true;
        console.log('[Clerk] ‚úÖ Authentication ready!');
        console.log('[Clerk] User signed in:', !!clerkInstance.user);

        return clerkInstance;
      } catch (error) {
        console.error('[Clerk] ‚ùå Failed to initialize:', error);
        console.error('[Clerk] Error name:', error.name);
        console.error('[Clerk] Error message:', error.message);
        console.error('[Clerk] Error stack:', error.stack);

        clerkLoaded = false;
        clerkInstance = null;
        throw new Error(`Authentication initialization failed: ${error.message}`);
      }
    }

    // ============================================
    // STATE PERSISTENCE FOR AUTHENTICATION FLOW
    // ============================================

    // Save app state to sessionStorage before authentication
    function saveAppState(state) {
      try {
        const stateToSave = {
          step: state.step,
          rightmoveUrl: state.rightmoveUrl,
          propertyInfo: state.propertyInfo,
          propertyImages: state.propertyImages,
          selectedImage: state.selectedImage,
          designStyle: state.designStyle,
          roomType: state.roomType,
          timeOfDay: state.timeOfDay,
          colourScheme: state.colourScheme,
          flooring: state.flooring,
          wallpaper: state.wallpaper,
          gardenStyle: state.gardenStyle,
          extraNotes: state.extraNotes,
          activeToggleId: state.activeToggleId,
          timestamp: Date.now()
        };
        sessionStorage.setItem('renovision_app_state', JSON.stringify(stateToSave));
        console.log('[State] Saved app state before authentication');
      } catch (error) {
        console.error('[State] Failed to save app state:', error);
      }
    }

    // Restore app state from sessionStorage after authentication
    function restoreAppState() {
      try {
        const savedState = sessionStorage.getItem('renovision_app_state');
        if (!savedState) {
          return null;
        }

        const state = JSON.parse(savedState);

        // Check if state is recent (within last 30 minutes)
        const MAX_AGE = 30 * 60 * 1000; // 30 minutes
        if (Date.now() - state.timestamp > MAX_AGE) {
          console.log('[State] Saved state expired, clearing');
          sessionStorage.removeItem('renovision_app_state');
          return null;
        }

        console.log('[State] Restored app state after authentication');
        // Clear the saved state after restoring
        sessionStorage.removeItem('renovision_app_state');
        return state;
      } catch (error) {
        console.error('[State] Failed to restore app state:', error);
        return null;
      }
    }

    // Global state saver for use in authentication flow
    window.__saveAppStateBeforeAuth = null;

    // Check if user is signed in, prompt if not
    async function requireAuthentication() {
      const clerk = await ensureClerkLoaded();

      if (!clerk.user) {
        // Save current app state before authentication
        if (window.__saveAppStateBeforeAuth) {
          window.__saveAppStateBeforeAuth();
        }

        // User not signed in - open sign-in modal
        await clerk.openSignIn();

        // Wait for sign-in to complete
        return new Promise((resolve, reject) => {
          const checkInterval = setInterval(() => {
            if (clerk.user) {
              clearInterval(checkInterval);
              resolve(clerk.user);
            }
          }, 500);

          // Timeout after 5 minutes
          setTimeout(() => {
            clearInterval(checkInterval);
            reject(new Error('Sign-in timeout'));
          }, 300000);
        });
      }

      return clerk.user;
    }

    // Helper to get session token
    async function getClerkSessionToken() {
      if (!clerkInstance || !clerkLoaded) {
        throw new Error('Clerk not initialized');
      }

      const session = clerkInstance.session;
      if (!session) {
        throw new Error('No active session. Please sign in.');
      }

      return await session.getToken();
    }

    // ============================================
    // AUTHENTICATED API HELPER
    // ============================================

    async function authenticatedFetch(url, options = {}) {
      try {
        // Ensure user is authenticated (will prompt if not)
        await requireAuthentication();

        // Get session token
        const clerk = await ensureClerkLoaded();
        const token = await clerk.session.getToken();

        const headers = {
          ...options.headers,
          'Authorization': `Bearer ${token}`
        };

        const response = await fetch(url, {
          ...options,
          headers
        });

        // Handle 401 specifically - session expired
        if (response.status === 401) {
          console.warn('[Auth] Session expired or invalid');
          // Prompt for re-authentication
          await requireAuthentication();
          // Retry the request
          return authenticatedFetch(url, options);
        }

        return response;

      } catch (error) {
        console.error('[Auth] API request failed:', error);
        throw error;
      }
    }

    // ============================================
    // COMPONENTS
    // ============================================

    function TogglePill({ label, active, onClick }) {
      return (
        <button
          onClick={(e) => onClick(e)}
          className={`toggle-pill ${active ? 'active' : ''}`}
        >
          {label}
        </button>
      );
    }

    function ColourTogglePill({ label, swatch, active, onClick }) {
      const needsBorder = ['#FAF8F4', '#F5F0E6', '#E8E8E8'].includes(swatch);

      // Calculate tinted background for selected state
      const getTintedBackground = (hex) => {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, 0.15)`;
      };

      return (
        <button
          onClick={(e) => onClick(e)}
          className="toggle-pill"
          style={active ? {
            background: getTintedBackground(swatch),
            borderColor: swatch,
            color: '#2c2c2c'
          } : {}}
        >
          <span style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
            <span
              style={{
                display: 'inline-block',
                width: '14px',
                height: '14px',
                borderRadius: '50%',
                backgroundColor: swatch,
                border: needsBorder ? '1px solid rgba(168, 159, 147, 0.3)' : 'none'
              }}
            />
            {label}
          </span>
        </button>
      );
    }

    function AccordionToggleGroup({ label, options, value, onChange, isOpen, onToggle, useColourSwatches }) {
      const headerRef = useRef(null);
      const pillRefs = useRef([]);

      const getSelectedLabel = () => {
        if (!value) return '';
        const option = options.find(o => o.id === value);
        return option ? option.label : '';
      };

      const handleToggleClick = () => {
        const wasOpen = isOpen;
        onToggle();

        // If opening this toggle, scroll it into perfect position after a brief delay
        if (!wasOpen && headerRef.current) {
          setTimeout(() => {
            const headerElement = headerRef.current;
            const headerRect = headerElement.getBoundingClientRect();
            const currentScrollY = window.scrollY || window.pageYOffset;

            // Calculate the position where the header would be at 80px from the top
            // This aligns the user's finger/cursor with the newly opened section
            const targetScrollY = currentScrollY + headerRect.top - 80;

            window.scrollTo({
              top: targetScrollY,
              behavior: 'smooth'
            });
          }, 150); // Small delay to allow the accordion to start opening
        }
      };

      const handlePillClick = (optionId, currentIndex, event) => {
        // Store the click position relative to the viewport
        const clickY = event.clientY;

        // Call the onChange handler
        onChange(optionId);

        // Auto-scroll to position the next pill at the click location
        setTimeout(() => {
          const nextIndex = currentIndex + 1;

          // If there's a next pill, scroll it into position
          if (nextIndex < options.length && pillRefs.current[nextIndex]) {
            const nextPill = pillRefs.current[nextIndex];
            const nextPillRect = nextPill.getBoundingClientRect();
            const currentScrollY = window.scrollY || window.pageYOffset;

            // Calculate how much to scroll so the next pill's center is at the click position
            const nextPillCenter = nextPillRect.top + (nextPillRect.height / 2);
            const scrollDelta = nextPillCenter - clickY;

            // Only scroll if there's a meaningful difference (more than 10px)
            if (Math.abs(scrollDelta) > 10) {
              window.scrollTo({
                top: currentScrollY + scrollDelta,
                behavior: 'smooth'
              });
            }
          }
        }, 50); // Small delay to allow state update
      };

      return (
        <div className="mb-4">
          <div
            ref={headerRef}
            className={`toggle-group-header ${isOpen ? 'expanded' : ''}`}
            onClick={handleToggleClick}
          >
            <div className="flex items-center gap-2">
              <span className="text-sm font-medium text-linen-800">{label}</span>
              {value && (
                <span className="text-sm text-linen-600">
                  {getSelectedLabel()}
                </span>
              )}
            </div>
            <svg
              className="chevron"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
            >
              <path d="M19 9l-7 7-7-7" />
            </svg>
          </div>

          <div className={`toggle-group-content ${isOpen ? 'expanded' : 'collapsed'}`}>
            <div className="toggle-group" style={{ paddingTop: '0.5rem' }}>
              {options.map((option, index) =>
                useColourSwatches ? (
                  <div key={option.id} ref={el => pillRefs.current[index] = el}>
                    <ColourTogglePill
                      label={option.label}
                      swatch={option.swatch}
                      active={value === option.id}
                      onClick={(e) => handlePillClick(option.id, index, e)}
                    />
                  </div>
                ) : (
                  <div key={option.id} ref={el => pillRefs.current[index] = el}>
                    <TogglePill
                      label={option.label}
                      active={value === option.id}
                      onClick={(e) => handlePillClick(option.id, index, e)}
                    />
                  </div>
                )
              )}
            </div>
          </div>
        </div>
      );
    }
    
    function CheckboxToggle({ label, checked, onChange }) {
      return (
        <div className="flex items-center justify-between py-4 border-b border-linen-300/50">
          <span className="text-sm text-linen-800">{label}</span>
          <div 
            className={`toggle-checkbox ${checked ? 'active' : ''}`}
            onClick={() => onChange(!checked)}
          />
        </div>
      );
    }

    // Loading dots animation component
    function LoadingDots() {
      const [dots, setDots] = useState('');

      useEffect(() => {
        const interval = setInterval(() => {
          setDots(prev => {
            if (prev === '...') return '';
            return prev + '.';
          });
        }, 400);
        return () => clearInterval(interval);
      }, []);

      return <span className="inline-block w-6 text-left">{dots}</span>;
    }

    // Loading message component with cycling witty messages
    function LoadingMessage() {
      // Start with a random message so users don't always see the same top 3
      const [messageIndex, setMessageIndex] = useState(() =>
        Math.floor(Math.random() * LOADING_MESSAGES.length)
      );
      const [isVisible, setIsVisible] = useState(true);

      useEffect(() => {
        const interval = setInterval(() => {
          setIsVisible(false); // fade out
          setTimeout(() => {
            setMessageIndex(prev => (prev + 1) % LOADING_MESSAGES.length);
            setIsVisible(true); // fade in
          }, 400); // Wait for fade out to complete before changing text
        }, 4000);

        return () => clearInterval(interval);
      }, []);

      return (
        <div className="min-h-[2.5rem] flex items-center justify-center px-4">
          <p
            className={`text-linen-600 text-sm md:text-base transition-opacity duration-300 text-center ${isVisible ? 'opacity-100' : 'opacity-0'}`}
            style={{ transitionTimingFunction: 'ease-in-out' }}
          >
            {LOADING_MESSAGES[messageIndex]}
          </p>
        </div>
      );
    }

    // Sparkling house animation component - randomly picks from 4 SVG frames
    function SparklingHouseAnimation() {
      const [frameIndex, setFrameIndex] = useState(0);
      const frames = ['assets/ani0.svg', 'assets/ani1.svg', 'assets/ani2.svg', 'assets/ani3.svg'];

      useEffect(() => {
        const interval = setInterval(() => {
          setFrameIndex(Math.floor(Math.random() * frames.length));
        }, 250); // 250ms (0.25 seconds) per frame

        return () => clearInterval(interval);
      }, []);

      return (
        <img
          src={frames[frameIndex]}
          alt="Loading animation"
          className="mb-3 w-20 h-20 md:w-24 md:h-24"
          style={{
            mixBlendMode: 'multiply',
            filter: 'contrast(1.2) brightness(0.95)',
            display: 'block',
            opacity: 0.95
          }}
        />
      );
    }

    // Rotating headline component with typewriter in and out animation
    function RotatingHeadline() {
      const [currentIndex, setCurrentIndex] = useState(() =>
        Math.floor(Math.random() * HOMEPAGE_HEADLINES.length)
      );
      const [displayedText, setDisplayedText] = useState('');
      const [isTypingIn, setIsTypingIn] = useState(true);
      const typewriterTimeout = useRef(null);
      const holdTimeout = useRef(null);

      useEffect(() => {
        const fullText = HOMEPAGE_HEADLINES[currentIndex];
        let charIndex = 0;

        setDisplayedText('');
        setIsTypingIn(true);

        // Type in phase
        const typeIn = () => {
          if (charIndex < fullText.length) {
            setDisplayedText(fullText.substring(0, charIndex + 1));
            charIndex++;
            const charDelay = 45 + Math.random() * 10; // 45-55ms
            typewriterTimeout.current = setTimeout(typeIn, charDelay);
          } else {
            // Typing in complete - hold phase
            holdTimeout.current = setTimeout(() => {
              // Start typing out
              setIsTypingIn(false);
              typeOut();
            }, 4000); // hold duration
          }
        };

        // Type out phase (reverse)
        const typeOut = () => {
          if (charIndex > 0) {
            charIndex--;
            setDisplayedText(fullText.substring(0, charIndex));
            const charDelay = 25 + Math.random() * 10; // 25-35ms (faster out)
            typewriterTimeout.current = setTimeout(typeOut, charDelay);
          } else {
            // Typing out complete - move to next headline
            setCurrentIndex(prev => (prev + 1) % HOMEPAGE_HEADLINES.length);
          }
        };

        typeIn();

        return () => {
          if (typewriterTimeout.current) clearTimeout(typewriterTimeout.current);
          if (holdTimeout.current) clearTimeout(holdTimeout.current);
        };
      }, [currentIndex]);

      return (
        <h1
          className="font-serif text-5xl md:text-6xl text-linen-900 mb-4 font-medium flex items-center justify-center text-center"
          style={{
            minHeight: '8rem'
          }}
        >
          {displayedText}
        </h1>
      );
    }

    // Configuration summary for results page
    function ConfigSummary({ style, roomType, timeOfDay, colourScheme, flooring, wallpaper, gardenStyle }) {
      const getLabelForId = (options, id) => {
        const option = options.find(o => o.id === id);
        return option ? option.label : null;
      };

      const items = [
        { label: 'Style', value: getLabelForId(DESIGN_STYLE_OPTIONS, style) },
        { label: 'Room', value: getLabelForId(ROOM_TYPE_OPTIONS, roomType) },
        { label: 'Garden Style', value: getLabelForId(GARDEN_STYLE_OPTIONS, gardenStyle) },
        { label: 'Lighting', value: getLabelForId(TIME_OF_DAY_OPTIONS, timeOfDay) },
        { label: 'Colours', value: getLabelForId(COLOUR_SCHEME_OPTIONS, colourScheme) },
        { label: 'Flooring', value: getLabelForId(FLOORING_OPTIONS, flooring) },
        { label: 'Wallpaper', value: wallpaper && wallpaper !== 'none' ? getLabelForId(WALLPAPER_OPTIONS, wallpaper) : null },
      ].filter(item => item.value);
      
      if (items.length === 0) return null;
      
      return (
        <div className="mt-6 p-4 card rounded-xl">
          <p className="text-xs text-linen-500 mb-3 uppercase tracking-wide">Applied settings</p>
          <div className="flex flex-wrap gap-2">
            {items.map((item, i) => (
              <span key={i} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-linen-200/50 rounded-full text-sm text-linen-700">
                <span className="text-linen-500">{item.label}:</span>
                <span className="font-medium">{item.value}</span>
              </span>
            ))}
          </div>
        </div>
      );
    }

    function ComparisonSlider({ beforeSrc, afterSrc }) {
      const containerRef = useRef(null);
      const beforeImgRef = useRef(null);
      const [sliderPosition, setSliderPosition] = useState(50);
      const [isDragging, setIsDragging] = useState(false);
      const [isTouching, setIsTouching] = useState(false);
      const [containerHeight, setContainerHeight] = useState(null);
      const scrollPosition = useRef(0);

      const lockBodyScroll = useCallback(() => {
        // Save current scroll position
        scrollPosition.current = window.pageYOffset || document.documentElement.scrollTop;

        // Lock scroll on body
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.top = `-${scrollPosition.current}px`;
        document.body.style.left = '0';
        document.body.style.right = '0';
        document.body.style.width = '100%';

        // Additional iOS Safari fix
        document.documentElement.style.overflow = 'hidden';
      }, []);

      const unlockBodyScroll = useCallback(() => {
        // Restore scroll
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.left = '';
        document.body.style.right = '';
        document.body.style.width = '';
        document.documentElement.style.overflow = '';

        // Restore scroll position
        window.scrollTo(0, scrollPosition.current);
      }, []);

      const handleMove = useCallback((clientX) => {
        if (!containerRef.current) return;
        const rect = containerRef.current.getBoundingClientRect();
        const x = clientX - rect.left;
        const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
        setSliderPosition(percentage);
      }, []);

      const handleMouseDown = () => setIsDragging(true);
      const handleMouseUp = () => setIsDragging(false);

      const handleMouseMove = useCallback((e) => {
        if (isDragging) handleMove(e.clientX);
      }, [isDragging, handleMove]);

      const handleTouchStart = useCallback((e) => {
        setIsTouching(true);
        lockBodyScroll();
        // Don't prevent default on touchStart to allow other interactions
      }, [lockBodyScroll]);

      const handleTouchMove = useCallback((e) => {
        if (isTouching || e.touches.length > 0) {
          // Prevent default to stop page scrolling
          if (e.cancelable) {
            e.preventDefault();
          }
          e.stopPropagation();
          handleMove(e.touches[0].clientX);
        }
      }, [handleMove, isTouching]);

      const handleTouchEnd = useCallback(() => {
        setIsTouching(false);
        unlockBodyScroll();
      }, [unlockBodyScroll]);

      useEffect(() => {
        document.addEventListener('mouseup', handleMouseUp);
        document.addEventListener('mousemove', handleMouseMove);
        return () => {
          document.removeEventListener('mouseup', handleMouseUp);
          document.removeEventListener('mousemove', handleMouseMove);
        };
      }, [handleMouseMove]);

      // Cleanup body scroll lock on unmount
      useEffect(() => {
        return () => {
          unlockBodyScroll();
        };
      }, [unlockBodyScroll]);

      // Calculate container dimensions based on before image
      useEffect(() => {
        const img = new Image();
        const updateDimensions = () => {
          if (containerRef.current && img.complete) {
            const containerWidth = containerRef.current.offsetWidth;
            const aspectRatio = img.height / img.width;
            const calculatedHeight = containerWidth * aspectRatio;
            setContainerHeight(calculatedHeight);
          }
        };

        img.onload = updateDimensions;
        img.src = beforeSrc;

        // Update on window resize
        window.addEventListener('resize', updateDimensions);
        return () => window.removeEventListener('resize', updateDimensions);
      }, [beforeSrc]);

      return (
        <div
          ref={containerRef}
          className="comparison-slider rounded-2xl overflow-hidden card"
          style={{
            height: containerHeight ? `${containerHeight}px` : 'auto',
            minHeight: containerHeight ? `${containerHeight}px` : '400px'
          }}
          onMouseDown={handleMouseDown}
          onTouchStart={handleTouchStart}
          onTouchMove={handleTouchMove}
          onTouchEnd={handleTouchEnd}
          onTouchCancel={handleTouchEnd}
          onDragStart={(e) => e.preventDefault()}
        >
          {/* Base layer: Original (before) image */}
          <img
            ref={beforeImgRef}
            src={beforeSrc}
            alt="Before"
            draggable="false"
          />

          {/* Overlay: AI generated (after) image that gets revealed */}
          <div
            className="comparison-after"
            style={{ clipPath: `inset(0 ${100 - sliderPosition}% 0 0)` }}
          >
            <img
              src={afterSrc}
              alt="After"
              draggable="false"
            />
          </div>

          <div
            className="comparison-handle"
            style={{ left: `${sliderPosition}%`, transform: 'translateX(-50%)' }}
          >
            <div className="comparison-grip">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2c2c2c" strokeWidth="2">
                <path d="M18 8L22 12L18 16" />
                <path d="M6 8L2 12L6 16" />
              </svg>
            </div>
          </div>

          {/* Labels with higher contrast and proper hiding behavior */}
          {/* Before label on left - hides when slider passes over it (when slider > ~20%) */}
          <div
            className="absolute bottom-4 left-4 px-3 py-1.5 rounded-full text-xs font-medium transition-opacity duration-200"
            style={{
              backgroundColor: 'rgba(253, 252, 251, 0.95)',
              color: '#2c2c2c',
              opacity: sliderPosition > 20 ? 0 : 1,
              pointerEvents: 'none'
            }}
          >
            Before
          </div>
          {/* After label on right - hides when slider passes under it (when slider < ~80%) */}
          <div
            className="absolute bottom-4 right-4 px-3 py-1.5 rounded-full text-xs font-medium transition-opacity duration-200"
            style={{
              backgroundColor: 'rgba(44, 44, 44, 0.95)',
              color: '#faf8f4',
              opacity: sliderPosition < 80 ? 0 : 1,
              pointerEvents: 'none'
            }}
          >
            After
          </div>
        </div>
      );
    }

    // Animated textarea component with typewriter placeholder
    function AnimatedTextarea({ value, onChange, label, sublabel }) {
      const [placeholder, setPlaceholder] = useState('');
      const [placeholderOpacity, setPlaceholderOpacity] = useState(1);
      const [currentSuggestionIndex, setCurrentSuggestionIndex] = useState(() =>
        Math.floor(Math.random() * EXTRA_NOTES_PLACEHOLDERS.length)
      );
      const previousIndexRef = useRef(-1);
      const [showHint, setShowHint] = useState(false);
      const [isMobile, setIsMobile] = useState(false);
      const typewriterTimeout = useRef(null);
      const pauseTimeout = useRef(null);
      const fadeTimeout = useRef(null);
      const textareaRef = useRef(null);
      const touchStartX = useRef(0);
      const touchStartY = useRef(0);

      // Function to get a random index that's different from the previous one
      const getRandomIndex = useCallback(() => {
        let newIndex;
        do {
          newIndex = Math.floor(Math.random() * EXTRA_NOTES_PLACEHOLDERS.length);
        } while (newIndex === previousIndexRef.current && EXTRA_NOTES_PLACEHOLDERS.length > 1);
        previousIndexRef.current = newIndex;
        return newIndex;
      }, []);

      // Detect mobile device
      useEffect(() => {
        const checkMobile = () => {
          setIsMobile(window.innerWidth < 768 || 'ontouchstart' in window);
        };
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // Lock in suggestion function
      const lockInSuggestion = useCallback(() => {
        if (placeholder && !value) {
          onChange({ target: { value: placeholder } });
          setPlaceholder('');
          setShowHint(false);
        }
      }, [placeholder, value, onChange]);

      // Handle Tab key press
      const handleKeyDown = useCallback((e) => {
        if (e.key === 'Tab' && placeholder && !value) {
          e.preventDefault();
          lockInSuggestion();
        }
      }, [placeholder, value, lockInSuggestion]);

      // Handle swipe right on mobile
      const handleTouchStart = useCallback((e) => {
        touchStartX.current = e.touches[0].clientX;
        touchStartY.current = e.touches[0].clientY;
      }, []);

      const handleTouchEnd = useCallback((e) => {
        if (!placeholder || value) return;

        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const deltaX = touchEndX - touchStartX.current;
        const deltaY = Math.abs(touchEndY - touchStartY.current);

        // Swipe right detection (minimum 50px, mostly horizontal)
        if (deltaX > 50 && deltaY < 30) {
          lockInSuggestion();
        }
      }, [placeholder, value, lockInSuggestion]);

      useEffect(() => {
        // Only animate placeholder when textarea is empty
        if (value && value.trim().length > 0) {
          setPlaceholder('');
          setPlaceholderOpacity(1);
          setShowHint(false);
          if (typewriterTimeout.current) clearTimeout(typewriterTimeout.current);
          if (pauseTimeout.current) clearTimeout(pauseTimeout.current);
          if (fadeTimeout.current) clearTimeout(fadeTimeout.current);
          return;
        }

        const currentText = EXTRA_NOTES_PLACEHOLDERS[currentSuggestionIndex];
        let charIndex = 0;

        const typeIn = () => {
          if (charIndex < currentText.length) {
            setPlaceholder(currentText.substring(0, charIndex + 1));
            charIndex++;
            const delay = 15 + Math.random() * 10; // 15-25ms per char (faster)
            typewriterTimeout.current = setTimeout(typeIn, delay);

            // Show hint when typing is halfway done
            if (charIndex === Math.floor(currentText.length / 2)) {
              setShowHint(true);
            }
          } else {
            // Finished typing - brief pause then fade out
            pauseTimeout.current = setTimeout(() => {
              // Fade out
              setPlaceholderOpacity(0);
              setShowHint(false);
              // Wait 40ms after fade, then move to random next
              fadeTimeout.current = setTimeout(() => {
                setPlaceholder('');
                setPlaceholderOpacity(1);
                setCurrentSuggestionIndex(getRandomIndex());
              }, 40);
            }, 2000); // 2 second pause before fade
          }
        };

        // Start typing after a brief delay
        pauseTimeout.current = setTimeout(() => {
          typeIn();
        }, 500);

        return () => {
          if (typewriterTimeout.current) clearTimeout(typewriterTimeout.current);
          if (pauseTimeout.current) clearTimeout(pauseTimeout.current);
          if (fadeTimeout.current) clearTimeout(fadeTimeout.current);
        };
      }, [currentSuggestionIndex, value, getRandomIndex]);

      return (
        <div className="mb-8 mt-8 relative">
          <label className="block text-sm font-medium text-linen-700 mb-1">
            {label}
          </label>
          {sublabel && (
            <p className="text-xs text-linen-500 mb-3">{sublabel}</p>
          )}
          <div className="relative">
            <textarea
              ref={textareaRef}
              value={value}
              onChange={onChange}
              onKeyDown={handleKeyDown}
              onTouchStart={handleTouchStart}
              onTouchEnd={handleTouchEnd}
              placeholder={placeholder}
              className="input-field resize-none h-28"
              style={{
                '--placeholder-opacity': placeholderOpacity
              }}
            />
            {showHint && placeholder && !value && (
              <div
                className="absolute bottom-3 right-3 text-xs text-linen-400 pointer-events-none transition-opacity duration-300"
                style={{ opacity: showHint ? 0.7 : 0 }}
              >
                {isMobile ? 'swipe right to enter' : 'tab to enter'}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============================================
    // MAIN APP
    // ============================================

    function App() {
      const [step, setStep] = useState(1);
      const [rightmoveUrl, setRightmoveUrl] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState(null);
      const homepageSubtitle = "Paste a Rightmove link or upload an image.";
      const [isDragging, setIsDragging] = useState(false);
      const fileInputRef = useRef(null);

      const [propertyInfo, setPropertyInfo] = useState(null);
      const [propertyImages, setPropertyImages] = useState([]);
      const [selectedImage, setSelectedImage] = useState(null);
      
      // Configuration toggles
      const [designStyle, setDesignStyle] = useState(null);
      const [roomType, setRoomType] = useState(null);
      const [timeOfDay, setTimeOfDay] = useState(null);
      const [colourScheme, setColourScheme] = useState(null);
      const [flooring, setFlooring] = useState(null);
      const [wallpaper, setWallpaper] = useState('none');
      const [gardenStyle, setGardenStyle] = useState(null);
      const [activeToggleId, setActiveToggleId] = useState('room');

      // Check if garden/outdoor is selected
      const isOutdoorSpace = roomType === 'garden' || roomType === 'outdoor';

      // Auto-advance to next toggle when a selection is made with stagger
      const handleRoomChange = (value) => {
        setRoomType(value);
        const isOutdoor = value === 'garden' || value === 'outdoor';

        if (value) {
          if (isOutdoor) {
            // For outdoor spaces, open garden style toggle
            setTimeout(() => {
              setActiveToggleId(null);
              setTimeout(() => setActiveToggleId('garden_style'), 100);
            }, 200);
          } else {
            // For indoor spaces, advance to style
            setTimeout(() => {
              setActiveToggleId(null);
              setTimeout(() => setActiveToggleId('style'), 100);
            }, 200);
          }
        }
      };

      const handleStyleChange = (value) => {
        setDesignStyle(value);
        if (value) {
          setTimeout(() => {
            setActiveToggleId(null);
            setTimeout(() => setActiveToggleId('time'), 100);
          }, 200);
        }
      };

      const handleTimeChange = (value) => {
        setTimeOfDay(value);
        if (value) {
          setTimeout(() => {
            setActiveToggleId(null);
            setTimeout(() => setActiveToggleId('colour'), 100);
          }, 200);
        }
      };

      const handleColourChange = (value) => {
        setColourScheme(value);
        if (value) {
          setTimeout(() => {
            setActiveToggleId(null);
            setTimeout(() => setActiveToggleId('floor'), 100);
          }, 200);
        }
      };

      const handleFloorChange = (value) => {
        setFlooring(value);
        if (value) {
          setTimeout(() => {
            setActiveToggleId(null);
            setTimeout(() => setActiveToggleId('wallpaper'), 100);
          }, 200);
        }
      };

      const handleWallpaperChange = (value) => {
        setWallpaper(value);
        if (value) {
          setTimeout(() => setActiveToggleId(null), 200);
        }
      };

      const handleGardenStyleChange = (value) => {
        setGardenStyle(value);
        if (value) {
          setTimeout(() => setActiveToggleId(null), 200);
        }
      };
      const [extraNotes, setExtraNotes] = useState('');

      const [generatedResult, setGeneratedResult] = useState(null);

      // ============================================
      // STATE PERSISTENCE HOOKS
      // ============================================

      // Restore state on mount if user was redirected from authentication
      useEffect(() => {
        const savedState = restoreAppState();
        if (savedState) {
          console.log('[App] Restoring saved state after authentication');

          // Restore all state variables
          if (savedState.step) setStep(savedState.step);
          if (savedState.rightmoveUrl) setRightmoveUrl(savedState.rightmoveUrl);
          if (savedState.propertyInfo) setPropertyInfo(savedState.propertyInfo);
          if (savedState.propertyImages) setPropertyImages(savedState.propertyImages);
          if (savedState.selectedImage) setSelectedImage(savedState.selectedImage);
          if (savedState.designStyle) setDesignStyle(savedState.designStyle);
          if (savedState.roomType) setRoomType(savedState.roomType);
          if (savedState.timeOfDay) setTimeOfDay(savedState.timeOfDay);
          if (savedState.colourScheme) setColourScheme(savedState.colourScheme);
          if (savedState.flooring) setFlooring(savedState.flooring);
          if (savedState.wallpaper) setWallpaper(savedState.wallpaper);
          if (savedState.gardenStyle) setGardenStyle(savedState.gardenStyle);
          if (savedState.extraNotes) setExtraNotes(savedState.extraNotes);
          if (savedState.activeToggleId) setActiveToggleId(savedState.activeToggleId);
        }
      }, []);

      // Register state saver function for authentication flow
      useEffect(() => {
        window.__saveAppStateBeforeAuth = () => {
          saveAppState({
            step,
            rightmoveUrl,
            propertyInfo,
            propertyImages,
            selectedImage,
            designStyle,
            roomType,
            timeOfDay,
            colourScheme,
            flooring,
            wallpaper,
            gardenStyle,
            extraNotes,
            activeToggleId
          });
        };

        return () => {
          window.__saveAppStateBeforeAuth = null;
        };
      }, [step, rightmoveUrl, propertyInfo, propertyImages, selectedImage, designStyle, roomType, timeOfDay, colourScheme, flooring, wallpaper, gardenStyle, extraNotes, activeToggleId]);

      // Function to get EXIF orientation and correct image rotation
      const getOrientedImage = async (file) => {
        return new Promise(async (resolve, reject) => {
          try {
            // Use createImageBitmap with imageOrientation: 'flipY' to handle EXIF automatically
            // This ensures the image is correctly oriented without manual transformation
            const imageBitmap = await createImageBitmap(file, {
              imageOrientation: 'from-image' // Respect EXIF orientation
            });

            // Create canvas with the correct dimensions
            const canvas = document.createElement('canvas');
            canvas.width = imageBitmap.width;
            canvas.height = imageBitmap.height;

            const ctx = canvas.getContext('2d');

            // Draw the image (already correctly oriented by createImageBitmap)
            ctx.drawImage(imageBitmap, 0, 0);

            // Convert to base64
            const base64Image = canvas.toDataURL('image/jpeg', 0.95);
            resolve(base64Image);
          } catch (error) {
            reject(error);
          }
        });
      };

      // Handle file upload (from input or drop)
      const handleFileUpload = async (file) => {
        if (!file || !file.type.startsWith('image/')) {
          setError('Please upload a valid image file (JPEG, PNG, etc.)');
          return;
        }

        setIsLoading(true);
        setError(null);

        try {
          // Get correctly oriented image
          const base64Image = await getOrientedImage(file);

          // Create image object
          const uploadedImage = {
            id: 1,
            url: base64Image,
            originalUrl: base64Image,
            room: 'unknown',
            caption: file.name
          };

          // Set image and go directly to configuration (Step 3)
          setPropertyImages([uploadedImage]);
          setSelectedImage(uploadedImage);

          setPropertyInfo({
            address: 'Uploaded Image',
            price: '',
            bedrooms: 0,
            bathrooms: 0,
            propertyType: ''
          });

          setIsLoading(false);
          setActiveToggleId('room'); // Start with Room Type open
          setStep(3);
          window.scrollTo(0, 0);
        } catch (err) {
          setError('Failed to process image. Please try again.');
          setIsLoading(false);
        }
      };

      // Drag and drop handlers
      const handleDragEnter = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(true);
      };

      const handleDragLeave = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };

      const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);

        const files = e.dataTransfer.files;
        if (files && files.length > 0) {
          handleFileUpload(files[0]);
        }
      };

      // File input change handler
      const handleFileInputChange = (e) => {
        const files = e.target.files;
        if (files && files.length > 0) {
          handleFileUpload(files[0]);
        }
      };

      const fetchPropertyImages = async (url) => {
        setIsLoading(true);
        setError(null);

        try {
          const response = await fetch(`${API_BASE_URL}/property`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });

          if (!response.ok) {
            const errorText = await response.text();
            try {
              const errorData = JSON.parse(errorText);
              throw new Error(errorData.detail || "That link's not quite right. Try a Rightmove property URL.");
            } catch (e) {
              throw new Error("That link's not quite right. Try a Rightmove property URL.");
            }
          }

          const data = await response.json();
          
          setPropertyInfo({
            address: data.address,
            price: data.price,
            bedrooms: data.bedrooms,
            bathrooms: data.bathrooms,
            propertyType: data.property_type
          });
          
          const imagePromises = data.images.map(async (img) => {
            const originalUrl = img.url_high_res || img.url;
            try {
              const proxyResponse = await fetch(`${API_BASE_URL}/proxy-image?url=${encodeURIComponent(originalUrl)}`);

              if (!proxyResponse.ok) {
                console.warn(`Failed to proxy image ${img.id}: HTTP ${proxyResponse.status}`);
                return null; // Skip failed images gracefully
              }

              const proxyData = await proxyResponse.json();

              if (!proxyData.data_url) {
                console.warn(`No data_url returned for image ${img.id}`);
                return null;
              }

              return {
                id: img.id,
                url: proxyData.data_url,
                originalUrl: originalUrl,
                room: img.room,
                caption: img.caption || ''
              };
            } catch (err) {
              console.error(`Error fetching image ${img.id}:`, err);
              return null; // Skip failed images instead of crashing
            }
          });

          const images = (await Promise.all(imagePromises)).filter(img => img && img.url);

          if (images.length === 0) {
            throw new Error('No images could be loaded. The property images may be unavailable or the proxy server may be experiencing issues.');
          }

          setPropertyImages(images);
          setIsLoading(false);
          setStep(2);
          window.scrollTo(0, 0);

        } catch (err) {
          setError(err.message);
          setIsLoading(false);
        }
      };

      const handleImageSelect = (image) => {
        setSelectedImage(image);
        setActiveToggleId('room'); // Start with Room Type open
        setStep(3);
        window.scrollTo(0, 0);
      };

      const generateRenovation = async () => {
        if (!selectedImage) return;

        setIsLoading(true);
        setError(null);
        setStep(4);
        window.scrollTo(0, 0);

        try {
          const requestPayload = {
            image_url: selectedImage.originalUrl,
            style: designStyle,
            room_type: roomType,
            time_of_day: timeOfDay,
            colour_scheme: colourScheme,
            flooring: flooring,
            wallpaper: wallpaper !== 'none' ? wallpaper : null,
            garden_style: gardenStyle,
            extra_notes: extraNotes || null
          };

          // Log the configuration being sent to the backend
          console.log('üé® Renovation Request Configuration:', {
            style: designStyle,
            room_type: roomType,
            time_of_day: timeOfDay,
            colour_scheme: colourScheme,
            flooring: flooring,
            wallpaper: wallpaper !== 'none' ? wallpaper : null,
            garden_style: gardenStyle,
            extra_notes: extraNotes || null
          });

          const response = await authenticatedFetch(`${API_BASE_URL}/renovate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestPayload)
          });

          if (!response.ok) {
            const errorText = await response.text();
            try {
              const errorData = JSON.parse(errorText);
              throw new Error(errorData.detail || 'Generation failed ‚Äî please try again.');
            } catch (e) {
              throw new Error('Generation failed ‚Äî please try again.');
            }
          }

          const data = await response.json();

          const result = {
            before: selectedImage.url,
            after: `data:image/jpeg;base64,${data.generated_image_base64}`,
            style: designStyle,
            roomType: roomType
          };

          setGeneratedResult(result);
          setIsLoading(false);
          
        } catch (err) {
          setError(err.message);
          setIsLoading(false);
        }
      };

      const resetApp = () => {
        setStep(1);
        setRightmoveUrl('');
        setPropertyInfo(null);
        setPropertyImages([]);
        setSelectedImage(null);
        setDesignStyle(null);
        setRoomType(null);
        setTimeOfDay(null);
        setColourScheme(null);
        setFlooring(null);
        setWallpaper('none');
        setGardenStyle(null);
        setExtraNotes('');
        setGeneratedResult(null);
        setError(null);
      };

      const goBackToSelection = () => {
        setSelectedImage(null);
        setDesignStyle(null);
        setRoomType(null);
        setTimeOfDay(null);
        setColourScheme(null);
        setFlooring(null);
        setWallpaper('none');
        setGardenStyle(null);
        setExtraNotes('');
        setError(null);

        // If there's only 1 image (uploaded image), go back to Step 1
        // Otherwise go to Step 2 (image selection)
        if (propertyImages.length === 1 && propertyImages[0].caption) {
          setStep(1);
          setPropertyImages([]);
          setPropertyInfo(null);
        } else {
          setStep(2);
        }
      };

      return (
        <div className="min-h-screen">
          {/* Header */}
          <header className="bg-linen-100/80 backdrop-blur-sm border-b border-linen-300/30 py-4 px-6 sticky top-0 z-50">
            <div className="max-w-5xl mx-auto flex items-center justify-between">
              <div className="flex items-center gap-3">
                <img
                  src={LOGO_URL}
                  alt="Renovision"
                  className="logo-img cursor-pointer transition-opacity hover:opacity-70"
                  onClick={resetApp}
                  onError={(e) => { e.target.style.display = 'none'; }}
                />
              </div>

              {step > 1 && (
                <button onClick={resetApp} className="btn-secondary text-sm py-2 px-4">
                  Start Over
                </button>
              )}
            </div>
          </header>

          <main className="max-w-5xl mx-auto px-6 py-12">
            
            {/* Step 1: URL Input or File Upload */}
            {step === 1 && (
              <div className="max-w-xl mx-auto text-center fade-in">
                <RotatingHeadline />
                <p className="text-linen-600 text-lg mb-10 font-light">
                  {homepageSubtitle}
                </p>

                <div className="card rounded-2xl p-8">
                  <label className="block text-left text-sm font-medium mb-3 text-linen-700">
                    Rightmove URL or Upload Image
                  </label>
                  <div className="flex flex-col sm:flex-row gap-3">
                    <div
                      className={`relative flex-1 transition-all duration-200 ${
                        isDragging ? 'opacity-80' : ''
                      }`}
                      onDragEnter={handleDragEnter}
                      onDragOver={handleDragOver}
                      onDragLeave={handleDragLeave}
                      onDrop={handleDrop}
                    >
                      <input
                        type="url"
                        value={rightmoveUrl}
                        onChange={(e) => setRightmoveUrl(e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter' && rightmoveUrl && !isLoading) {
                            fetchPropertyImages(rightmoveUrl);
                          }
                        }}
                        placeholder="Paste URL or drag & drop image here..."
                        className={`input-field w-full pr-12 transition-all duration-200 ${
                          isDragging ? 'border-linen-700 bg-linen-200/50 border-2' : ''
                        }`}
                      />
                      <button
                        onClick={() => fileInputRef.current?.click()}
                        disabled={isLoading}
                        className="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-linen-500 hover:text-linen-700 transition-colors rounded-lg hover:bg-linen-100"
                        title="Upload image"
                        type="button"
                      >
                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                      </button>
                      <input
                        ref={fileInputRef}
                        type="file"
                        accept="image/*"
                        onChange={handleFileInputChange}
                        className="hidden"
                      />
                    </div>
                    <button
                      onClick={() => fetchPropertyImages(rightmoveUrl)}
                      disabled={!rightmoveUrl || isLoading}
                      className="btn-primary whitespace-nowrap"
                    >
                      {isLoading ? (
                        <span className="flex items-center gap-2">
                          <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                          </svg>
                          Loading
                        </span>
                      ) : 'Fetch Property'}
                    </button>
                  </div>

                  {error && (
                    <p className="text-red-600 text-sm mt-4 text-left">{error}</p>
                  )}
                </div>
              </div>
            )}

            {/* Step 2: Image Selection */}
            {step === 2 && (
              <div className="fade-in">
                {propertyInfo && (
                  <div className="card rounded-2xl p-6 mb-8 max-w-lg mx-auto text-center">
                    <h2 className="font-serif text-2xl text-linen-900 mb-2">{propertyInfo.address}</h2>
                    <div className="flex flex-wrap justify-center gap-3 text-linen-600 text-sm">
                      <span className="font-medium text-linen-800">{propertyInfo.price}</span>
                      {propertyInfo.bedrooms > 0 && <span>{propertyInfo.bedrooms} bed</span>}
                      {propertyInfo.bathrooms > 0 && <span>{propertyInfo.bathrooms} bath</span>}
                    </div>
                  </div>
                )}
                
                <div className="text-center mb-8">
                  <h2 className="font-serif text-3xl md:text-4xl text-linen-900 mb-2">Choose a room</h2>
                  <p className="text-linen-600">Click any image to configure your renovation.</p>
                </div>
                
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  {propertyImages.map((image) => (
                    <div
                      key={image.id}
                      onClick={() => handleImageSelect(image)}
                      className="image-card rounded-xl overflow-hidden card-hover aspect-[4/3]"
                    >
                      <img
                        src={image.url}
                        alt="Property image"
                        className="w-full h-full object-cover"
                      />
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Step 3: Configure */}
            {step === 3 && selectedImage && (
              <div className="fade-in">
                <button
                  onClick={goBackToSelection}
                  className="flex items-center gap-2 text-linen-600 hover:text-linen-800 mb-6 transition-colors"
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                  {propertyImages.length === 1 && propertyImages[0].caption ? 'Back to upload' : 'Back to images'}
                </button>
                
                <div className="grid lg:grid-cols-2 gap-10">
                  <div className="lg:sticky lg:top-24 lg:self-start">
                    <div className="card rounded-2xl overflow-hidden">
                      <img 
                        src={selectedImage.url} 
                        alt="Selected room"
                        className="w-full"
                      />
                    </div>
                  </div>
                  
                  <div>
                    <h2 className="font-serif text-3xl text-linen-900 mb-2">Configure your renovation</h2>
                    <p className="text-linen-600 mb-8">Options, like dinner guests, may be politely ignored.</p>

                    <AccordionToggleGroup
                      label="Room Type"
                      options={ROOM_TYPE_OPTIONS}
                      value={roomType}
                      onChange={handleRoomChange}
                      isOpen={activeToggleId === 'room'}
                      onToggle={() => setActiveToggleId(activeToggleId === 'room' ? null : 'room')}
                    />

                    {isOutdoorSpace && (
                      <AccordionToggleGroup
                        label="Garden Style"
                        options={GARDEN_STYLE_OPTIONS}
                        value={gardenStyle}
                        onChange={handleGardenStyleChange}
                        isOpen={activeToggleId === 'garden_style'}
                        onToggle={() => setActiveToggleId(activeToggleId === 'garden_style' ? null : 'garden_style')}
                      />
                    )}

                    {!isOutdoorSpace && (
                      <>
                        <AccordionToggleGroup
                          label="Interior Design Style"
                          options={DESIGN_STYLE_OPTIONS}
                          value={designStyle}
                          onChange={handleStyleChange}
                          isOpen={activeToggleId === 'style'}
                          onToggle={() => setActiveToggleId(activeToggleId === 'style' ? null : 'style')}
                        />

                        <AccordionToggleGroup
                          label="Time of Day"
                          options={TIME_OF_DAY_OPTIONS}
                          value={timeOfDay}
                          onChange={handleTimeChange}
                          isOpen={activeToggleId === 'time'}
                          onToggle={() => setActiveToggleId(activeToggleId === 'time' ? null : 'time')}
                        />

                        <AccordionToggleGroup
                          label="Colour Scheme"
                          options={COLOUR_SCHEME_OPTIONS}
                          value={colourScheme}
                          onChange={handleColourChange}
                          isOpen={activeToggleId === 'colour'}
                          onToggle={() => setActiveToggleId(activeToggleId === 'colour' ? null : 'colour')}
                          useColourSwatches={true}
                        />

                        <AccordionToggleGroup
                          label="Flooring"
                          options={FLOORING_OPTIONS}
                          value={flooring}
                          onChange={handleFloorChange}
                          isOpen={activeToggleId === 'floor'}
                          onToggle={() => setActiveToggleId(activeToggleId === 'floor' ? null : 'floor')}
                        />

                        <AccordionToggleGroup
                          label="Wallpaper"
                          options={WALLPAPER_OPTIONS}
                          value={wallpaper}
                          onChange={handleWallpaperChange}
                          isOpen={activeToggleId === 'wallpaper'}
                          onToggle={() => setActiveToggleId(activeToggleId === 'wallpaper' ? null : 'wallpaper')}
                        />
                      </>
                    )}
                    
                    <AnimatedTextarea
                      value={extraNotes}
                      onChange={(e) => setExtraNotes(e.target.value)}
                      label="Extra Notes"
                      sublabel="Be as specific as you like"
                    />

                    <div className="mt-10">
                      <button
                        onClick={generateRenovation}
                        className="btn-primary w-full text-lg py-4"
                      >
                        Generate Renovation
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Step 4: Result */}
            {step === 4 && (
              <div className="fade-in">
                <div className="text-center mb-10">
                  <h2 className="font-serif text-3xl md:text-4xl text-linen-900 mb-2">
                    {isLoading ? (<>Creating your vision<LoadingDots /></>) : 'Your renovation'}
                  </h2>
                  <p className="text-linen-600">
                    {isLoading
                      ? 'This usually takes around 15 seconds.'
                      : 'Drag the slider to compare before and after.'}
                  </p>
                </div>

                {isLoading ? (
                  <div className="max-w-3xl mx-auto px-4">
                    {/* Rounded white box matching generated photo size - with padding to keep content contained */}
                    <div
                      className="rounded-2xl aspect-[4/3] flex flex-col items-center justify-center p-6 md:p-8"
                      style={{
                        background: '#FFFFFF',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.04), 0 4px 12px rgba(0, 0, 0, 0.02)',
                        isolation: 'isolate'
                      }}
                    >
                      {/* Sparkling house animation */}
                      <SparklingHouseAnimation />

                      {/* Loading text closer to logo and fully contained within box */}
                      <div className="text-center w-full">
                        <LoadingMessage />
                      </div>
                    </div>
                  </div>
                ) : error ? (
                  <div className="max-w-lg mx-auto text-center">
                    <div className="card rounded-2xl p-8">
                      <p className="text-red-600 mb-4">Even masterpieces hit snags. Give it another go?</p>
                      <button onClick={goBackToSelection} className="btn-secondary">
                        Try Again
                      </button>
                    </div>
                  </div>
                ) : generatedResult && (
                  <div className="max-w-3xl mx-auto">
                    <ComparisonSlider
                      beforeSrc={generatedResult.before}
                      afterSrc={generatedResult.after}
                    />
                    
                    <ConfigSummary
                      style={designStyle}
                      roomType={roomType}
                      timeOfDay={timeOfDay}
                      colourScheme={colourScheme}
                      flooring={flooring}
                      wallpaper={wallpaper}
                      gardenStyle={gardenStyle}
                    />
                    
                    <div className="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                      <button
                        onClick={async () => {
                          // Detect iOS device
                          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

                          if (isIOS && navigator.share) {
                            // On iOS with Web Share API support, use native share
                            try {
                              // Convert base64 to blob
                              const response = await fetch(generatedResult.after);
                              const blob = await response.blob();
                              const file = new File([blob], `renovision-${generatedResult.roomType || 'room'}-${generatedResult.style || 'styled'}.jpg`, { type: 'image/jpeg' });

                              await navigator.share({
                                files: [file],
                                title: 'Renovision Image',
                                text: 'Save to Photos'
                              });
                            } catch (err) {
                              // If share fails, fall back to download
                              console.log('Share failed, using download fallback:', err);
                              const link = document.createElement('a');
                              link.href = generatedResult.after;
                              link.download = `renovision-${generatedResult.roomType || 'room'}-${generatedResult.style || 'styled'}.jpg`;
                              document.body.appendChild(link);
                              link.click();
                              document.body.removeChild(link);
                            }
                          } else {
                            // On other devices, use regular download
                            const link = document.createElement('a');
                            link.href = generatedResult.after;
                            link.download = `renovision-${generatedResult.roomType || 'room'}-${generatedResult.style || 'styled'}.jpg`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                          }
                        }}
                        className="btn-primary"
                      >
                        {/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream ? 'Save to Photos' : 'Download Image'}
                      </button>
                      <button onClick={goBackToSelection} className="btn-secondary">
                        Try Another Room
                      </button>
                      <button onClick={resetApp} className="btn-secondary">
                        New Property
                      </button>
                    </div>
                  </div>
                )}
              </div>
            )}
          </main>

          <footer className="border-t border-linen-300/30 py-8 px-6 mt-16">
            <div className="max-w-5xl mx-auto text-center text-sm text-linen-500">
              <p className="flex flex-col items-center gap-1">
                <span>Powered by cutting-edge generative models.</span>
                <span>Designed & built by Wallcache Studios.</span>
              </p>
            </div>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
