<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Renovision. A Doer-Upper's Best Friend.</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwindcss.config = {
      theme: {
        extend: {
          fontFamily: {
            serif: ['Cormorant Garamond', 'Georgia', 'serif'],
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            linen: {
              50: '#fdfcfb',
              100: '#faf8f4',
              200: '#f2efe9',
              300: '#e8e4dc',
              400: '#d4cfc4',
              500: '#b8b1a4',
              600: '#a89f93',
              700: '#8a8278',
              800: '#6b655c',
              900: '#2c2c2c',
            },
            taupe: {
              light: '#c4bbb0',
              DEFAULT: '#a89f93',
              dark: '#8a8278',
            },
            sage: {
              light: '#d4ddd4',
              DEFAULT: '#9aab9a',
              dark: '#7a8f7a',
            },
            clay: {
              light: '#e8d8cc',
              DEFAULT: '#c9a88a',
              dark: '#a68b6a',
            }
          }
        }
      }
    }
  </script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #faf8f4;
      color: #2c2c2c;
      min-height: 100vh;
    }
    
    .font-serif {
      font-family: 'Cormorant Garamond', Georgia, serif;
    }
    
    /* Subtle linen texture */
    .linen-texture {
      background-image: 
        linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%),
        url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.02'/%3E%3C/svg%3E");
    }
    
    /* Card styles */
    .card {
      background: linear-gradient(145deg, #fdfcfb 0%, #f8f6f2 100%);
      border: 1px solid rgba(168, 159, 147, 0.15);
      box-shadow: 
        0 1px 3px rgba(0, 0, 0, 0.04),
        0 4px 12px rgba(0, 0, 0, 0.02);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.06),
        0 8px 24px rgba(0, 0, 0, 0.04);
      border-color: rgba(168, 159, 147, 0.3);
    }
    
    /* Image card selection */
    .image-card {
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .image-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, transparent 60%, rgba(44, 44, 44, 0.4) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .image-card:hover::after {
      opacity: 1;
    }
    
    .image-card:hover {
      transform: scale(1.02);
    }
    
    .image-card:hover .select-hint {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Toggle pill buttons */
    .toggle-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .toggle-pill {
      padding: 0.625rem 1.25rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 400;
      background: #f2efe9;
      border: 1px solid rgba(168, 159, 147, 0.2);
      color: #6b655c;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle-pill:hover {
      background: #e8e4dc;
      border-color: rgba(168, 159, 147, 0.4);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .toggle-pill:active {
      transform: scale(0.97);
    }

    .toggle-pill.active {
      background: #2c2c2c;
      border-color: #2c2c2c;
      color: #faf8f4;
    }

    /* Accordion toggle groups */
    .toggle-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #f8f6f2;
      border-radius: 0.75rem;
      cursor: pointer;
      margin-bottom: 0.5rem;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle-group-header:hover {
      background: #f2efe9;
    }

    .toggle-group-header .selected-value {
      color: #6b655c;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toggle-group-header .chevron {
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      color: #a89f93;
    }

    .toggle-group-header.expanded .chevron {
      transform: rotate(180deg);
    }

    .toggle-group-content {
      overflow: hidden;
      transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toggle-group-content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    .toggle-group-content.expanded {
      max-height: 600px;
      opacity: 1;
      padding-bottom: 1rem;
    }
    
    /* Button styles */
    .btn-primary {
      background: #2c2c2c;
      color: #faf8f4;
      border: none;
      border-radius: 9999px;
      padding: 1rem 2rem;
      font-weight: 500;
      transition: all 0.25s ease;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #1a1a1a;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(44, 44, 44, 0.15);
    }
    
    .btn-primary:disabled {
      background: #d4cfc4;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: transparent;
      color: #6b655c;
      border: 1px solid rgba(168, 159, 147, 0.3);
      border-radius: 9999px;
      padding: 0.875rem 1.75rem;
      font-weight: 400;
      transition: all 0.25s ease;
    }
    
    .btn-secondary:hover {
      background: #f2efe9;
      border-color: rgba(168, 159, 147, 0.5);
    }
    
    /* Input styles */
    .input-field {
      background: #fdfcfb;
      border: 1px solid rgba(168, 159, 147, 0.25);
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      font-size: 0.9375rem;
      color: #2c2c2c;
      transition: all 0.25s ease;
      width: 100%;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #a89f93;
      box-shadow: 0 0 0 3px rgba(168, 159, 147, 0.1);
    }
    
    .input-field::placeholder {
      color: #b8b1a4;
      opacity: var(--placeholder-opacity, 1);
      transition: opacity 0.3s ease-out;
    }

    .input-field::-webkit-input-placeholder {
      opacity: var(--placeholder-opacity, 1);
      transition: opacity 0.3s ease-out;
    }

    .input-field::-moz-placeholder {
      opacity: var(--placeholder-opacity, 1);
      transition: opacity 0.3s ease-out;
    }

    .input-field:-ms-input-placeholder {
      opacity: var(--placeholder-opacity, 1);
      transition: opacity 0.3s ease-out;
    }
    
    /* Comparison slider */
    .comparison-slider {
      position: relative;
      overflow: hidden;
      cursor: ew-resize;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: none;
      -webkit-touch-callout: none;
    }
    
    .comparison-slider img {
      display: block;
      width: 100%;
      height: auto;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
    }
    
    .comparison-after {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    .comparison-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #faf8f4;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }
    
    .comparison-grip {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 44px;
      height: 44px;
      background: #faf8f4;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    .loading-pulse {
      animation: pulse 2s ease-in-out infinite;
    }

    /* Organic blob rotation animation */
    @keyframes rotate-blob {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .rotating-blob {
      animation: rotate-blob 3s linear infinite;
    }
    
    /* Fade animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    /* Checkbox toggle */
    .toggle-checkbox {
      position: relative;
      width: 48px;
      height: 28px;
      background: #e8e4dc;
      border-radius: 9999px;
      cursor: pointer;
      transition: background 0.25s ease;
    }
    
    .toggle-checkbox.active {
      background: #2c2c2c;
    }
    
    .toggle-checkbox::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: #fdfcfb;
      border-radius: 50%;
      transition: transform 0.25s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .toggle-checkbox.active::after {
      transform: translateX(20px);
    }
    
    /* Logo */
    .logo-img {
      height: 36px;
      width: auto;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f2efe9;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #d4cfc4;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #b8b1a4;
    }
  </style>
</head>
<body class="min-h-screen linen-texture">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============================================
    // CONFIGURATION
    // ============================================
    
    const API_BASE_URL = 'https://renovision-5z2b.onrender.com';
    const LOGO_URL = 'logo.png';
    
    // Toggle options
    const DESIGN_STYLE_OPTIONS = [
      { id: 'midcentury', label: 'Mid-Century' },
      { id: 'minimal', label: 'Minimal' },
      { id: 'industrial', label: 'Industrial' },
      { id: 'scandinavian', label: 'Scandinavian' },
      { id: 'wabisabi', label: 'Wabi-Sabi' },
      { id: 'mediterranean', label: 'Mediterranean' },
    ];

    const ROOM_TYPE_OPTIONS = [
      { id: 'living', label: 'Living' },
      { id: 'bedroom', label: 'Bedroom' },
      { id: 'kitchen', label: 'Kitchen' },
      { id: 'dining', label: 'Dining' },
      { id: 'bathroom', label: 'Bathroom' },
      { id: 'office', label: 'Office' },
      { id: 'hallway', label: 'Hallway' },
      { id: 'garden', label: 'Garden' },
      { id: 'outdoor', label: 'Outdoor' },
    ];

    const TIME_OF_DAY_OPTIONS = [
      { id: 'day', label: 'Day' },
      { id: 'night', label: 'Night' },
      { id: 'golden_hour', label: 'Golden Hour' },
    ];

    const COLOUR_SCHEME_OPTIONS = [
      { id: 'soft_linen', label: 'Soft Linen', swatch: '#FAF8F4' },
      { id: 'cream_core', label: 'Cream Core', swatch: '#F5F0E6' },
      { id: 'sage_calm', label: 'Sage Calm', swatch: '#9CAF88' },
      { id: 'terracotta_sun', label: 'Terracotta Sun', swatch: '#C67D5E' },
      { id: 'olive_grove', label: 'Olive Grove', swatch: '#708238' },
      { id: 'burgundy_depth', label: 'Burgundy Depth', swatch: '#722F37' },
      { id: 'forest_green', label: 'Forest Green', swatch: '#228B22' },
      { id: 'midnight_blue', label: 'Midnight Blue', swatch: '#191970' },
      { id: 'amber_glow', label: 'Amber Glow', swatch: '#FFBF00' },
      { id: 'nordic_mist', label: 'Nordic Mist', swatch: '#E8E8E8' },
    ];

    const FLOORING_OPTIONS = [
      { id: 'wood_parquet', label: 'Wood Parquet' },
      { id: 'tiled', label: 'Tiled' },
      { id: 'stone_slabs', label: 'Stone Slabs' },
      { id: 'polished_concrete', label: 'Polished Concrete' },
      { id: 'carpetted', label: 'Carpetted' },
    ];

    const LOADING_MESSAGES = [
      "Overshooting the budget...",
      "Knocking through a wall or two...",
      "Arguing with the listed building officer...",
      "Convincing the neighbours about the extension...",
      "Sourcing reclaimed victorian floorboards...",
      "Haggling at the antique market...",
      "Pretending to understand load-bearing walls...",
      "Googling 'is farrow & ball worth it'...",
      "Adding another velvet sofa...",
      "Removing the previous owner's wallpaper choices...",
      "Manifesting off-street parking...",
      "Installing underfloor heating retrospectively...",
      "Finding a builder who'll actually call back...",
      "Justifying the statement pendant light...",
      "Hiding the boiler somewhere clever...",
      "Making the most of the 'cosy' proportions...",
      "Explaining 'open-plan living' to a 1930s semi...",
      "Choosing between hague blue and stiffkey blue...",
      "Measuring twice, cutting once...",
      "Persuading the mortgage lender it's 'characterful'...",
      "Adding a boot room no one asked for...",
      "Squeezing in a downstairs loo...",
      "Deciding the kitchen island is non-negotiable...",
      "Imagining what 'good bones' actually means...",
      "Desperately re-aligning the sofa with better chi...",
      "Squinting past the fisheye lens distortion...",
      "Translating 'cosy' into square-foot reality...",
      "Blaming bad layouts on blocked qi...",
      "Counting plug sockets like it's a sport...",
      "Deciding that moving one door could heal everything...",
      "Mentally removing decades of bad laminate...",
      "Diagnosing 'stagnant energy' in windowless toilets...",
      "Arguing if the staircase is stealing our fortune luck...",
      "Negotiating with ourselves about ceiling heights...",
      "Measuring imaginary islands in tiny kitchens...",
      "Declaring open-plan chaos 'energetically aggressive'...",
      "Deleting virtual feature walls aggressively...",
      "Re-aligning bed placement for maximum dream potency...",
      "Judging the stairs for creak potential...",
      "Worrying the front door doesn't welcome prosperity properly...",
      "Deciding which walls are emotionally load-bearing...",
      "Calculating skylight-to-daylight ratios...",
      "Imagining plants where carpets fear to tread...",
      "Dreaming of underfloor heating while standing on lino...",
      "Rotating sofas that don't exist yet...",
      "Checking sightlines for the perfect morning coffee spot...",
      "Plotting the demise of the shower-over-bath...",
      "Evaluating whether a utility room is a personality trait...",
      "Removing fake beams with violent enthusiasm...",
      "Stepping over estate agent zoom blur...",
      "Prosecuting the layout for crimes against flow...",
      "Re-routing imaginary plumbing with confidence...",
      "Removing chimney breasts in our minds already...",
      "Visualising a reading nook in the smallest corner possible...",
      "Converting box rooms into 'studios' (emotionally)...",
      "Playing 'wall or structural column?' roulette...",
      "Forecasting how many skips we'll need...",
      "Assigning vibes to rooms we haven't built yet...",
      "Questioning every randomly placed radiator...",
      "Planning dramatic pendant lighting moments...",
      "Working out if that alcove could house a wine fridge...",
      "Rewriting 'unique layout' as 'chaotic geometry'...",
      "Mentally widening hallways with sheer willpower...",
      "Test-fitting future christmas trees into odd rooms...",
    ];

    const HOMEPAGE_HEADLINES = [
      "See What This Place Could Become.",
      "Discover What's Possible.",
      "Find The Beauty In The Bones.",
      "Every Room Has A Second Act.",
      "Potential, Revealed.",
      "Look Past The Artex.",
      "See Beyond The Magnolia.",
      "Ignore The Carpets. We Did.",
      "That Wallpaper Won't Be There Long.",
      "Underneath That Avocado Bathroom...",
      "What If The Previous Owners Had Taste?",
      "A Doer-Upper's Best Friend.",
      "For Those Who See Past The Photos.",
      "Renovate Before You Buy.",
      "Your Architect's First Draft.",
      "Skip The Guesswork.",
      "See The Finish Line First.",
      "Where Imagination Meets Square Footage.",
      "Turn 'It Has Potential' Into Proof.",
      "Make The Estate Agent's Lies Come True.",
      "Because 'Needs Updating' Means Opportunity.",
      "Visualise The Potential.",
    ];

    const HOMEPAGE_SUBTITLES = [
      "Drop a property link and let possibility take centre stage.",
      "Paste a link, and watch potential unfurl like a well-cut curtain.",
      "Enter a property link, and behold the drama of what could be.",
      "Share a link, and let imagination do the heavy lifting.",
      "Paste a property, and let opportunity strike a pose.",
      "Submit a link, and watch ordinary rooms learn extraordinary tricks.",
      "Give us a link, and let potential have its moment in the spotlight.",
    ];

    const EXTRA_NOTES_PLACEHOLDERS = [
      "Pop a Keith Haring on that wall, your sofa will thank you...",
      "A Togo in neon orange might clash gloriously with that rug...",
      "Imagine a Labradoodle sprawled on the velvet armchair...",
      "Maybe a gold-trimmed mirror that makes your hallway look heroic...",
      "Hang a disco ball above the kitchen island, why not...",
      "Scatter cushions like confetti on the sofa, bold and unapologetic...",
      "A stack of mid-century coffee table books, just begging to be spilled...",
      "Put a tiny cactus army on the windowsill...",
      "Maybe a velvet pouf where nobody will sit but it looks fabulous...",
      "Brass taps in the kitchen that scream, \"I'm worth it\"...",
      "A neon sign saying \"Dinner Served?\" above the stove...",
      "A potted palm in the corner like it owns the place...",
      "Add a geometric rug so sharp it could cut feelings...",
      "A vintage record player with jazz spilling like spilled wine...",
      "A framed dog portrait, bonus points if it's wearing sunglasses...",
      "Floor cushions in crazy prints for impromptu dance-offs...",
      "A statement pendant light that doubles as a conversation starter...",
      "Some mismatched chairs around the table, chaos looks chic...",
      "A little gold statue that nobody knows the origin of...",
      "Hang a map with pins where you've never been...",
      "A velvet headboard so dramatic it deserves its own theme song...",
      "A neon flamingo lamp because subtle is overrated...",
      "A beanbag in the reading nook for dramatic lounging...",
      "An oversized clock that looks like it belongs in a Wes Anderson film...",
      "Throw in a basket of ridiculously fluffy throws, because why not...",
      "A single monstera leaf in a glass vase, majestically lonely...",
      "A tiny dog bowl in designer chic, just for laughs...",
      "A coffee table that doubles as a mini gallery of oddities...",
      "A bright wallpaper corner no one can resist photographing...",
      "A chandelier above the bed for your inner royalty to thrive...",
      "Imagine a velvet chaise for napping while pondering the futility of existence...",
      "A gilt-framed portrait of a cat judging your life choices...",
      "Scatter books like breadcrumbs, leading to some secret philosophical revelation...",
      "A single candle burning next to a half-empty glass of wine...",
      "An antique globe with pins in countries you've only dreamed of visiting...",
      "A brass telescope pointing out the window to nowhere in particular...",
      "A velvet footstool that doubles as a throne for your inner aristocrat...",
      "A neon sign that says \"Why Not?\" blinking at random intervals...",
      "A Labrador in a cashmere sweater lying on a Persian rug...",
      "A chandelier so flamboyant it demands applause from the furniture...",
      "A tiny bonsai in the corner contemplating its own mortality...",
      "A Togo sofa in shocking pink, unapologetically clashing with the walls...",
      "Floor cushions arranged like they've hosted secret salons...",
      "A golden pineapple that refuses to be ignored...",
      "A fireplace mantel decorated with absurdly ornate clocks ticking at their own pace...",
      "A throw so fluffy it could smother small existential dread...",
      "A single, dramatic velvet curtain blowing slightly, as if sighing...",
      "A vintage gramophone playing jazz only when nobody is looking...",
      "A coffee table with a hidden drawer full of scandalous secrets...",
      "A staircase lined with tiny portraits of eccentric ancestors...",
      "A teacup on a saucer perched precariously, like a statement of rebellion...",
      "A massive potted palm pretending it owns the room...",
      "An oversized mirror angled to reflect all the wrong angles beautifully...",
      "A single pendant light casting shadows that look suspiciously like dancing...",
      "A rug that seems to whisper \"sit here, contemplate life\"...",
      "A stack of mismatched cushions that would survive the apocalypse...",
      "A tiny sculpture holding a wine glass, silently judging guests...",
      "A velvet armchair that looks cozy but only for aristocrats or poets...",
      "A floor lamp bending slightly as if bowing in reverence...",
      "A faint smell of old books and chocolate drifting from nowhere...",
    ];

    // ============================================
    // COMPONENTS
    // ============================================
    
    function TogglePill({ label, active, onClick }) {
      return (
        <button
          onClick={onClick}
          className={`toggle-pill ${active ? 'active' : ''}`}
        >
          {label}
        </button>
      );
    }

    function ColourTogglePill({ label, swatch, active, onClick }) {
      const needsBorder = ['#FAF8F4', '#F5F0E6', '#E8E8E8'].includes(swatch);

      // Calculate tinted background for selected state
      const getTintedBackground = (hex) => {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, 0.15)`;
      };

      return (
        <button
          onClick={onClick}
          className="toggle-pill"
          style={active ? {
            background: getTintedBackground(swatch),
            borderColor: swatch,
            color: '#2c2c2c'
          } : {}}
        >
          <span style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
            <span
              style={{
                display: 'inline-block',
                width: '14px',
                height: '14px',
                borderRadius: '50%',
                backgroundColor: swatch,
                border: needsBorder ? '1px solid rgba(168, 159, 147, 0.3)' : 'none'
              }}
            />
            {label}
          </span>
        </button>
      );
    }

    function AccordionToggleGroup({ label, options, value, onChange, isOpen, onToggle, useColourSwatches }) {
      const getSelectedLabel = () => {
        if (!value) return '';
        const option = options.find(o => o.id === value);
        return option ? option.label : '';
      };

      return (
        <div className="mb-4">
          <div
            className={`toggle-group-header ${isOpen ? 'expanded' : ''}`}
            onClick={onToggle}
          >
            <div>
              <div className="text-sm font-medium text-linen-800">{label}</div>
              {value && (
                <div className="selected-value">
                  <span>✓</span>
                  <span>{getSelectedLabel()}</span>
                </div>
              )}
            </div>
            <svg
              className="chevron"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
            >
              <path d="M19 9l-7 7-7-7" />
            </svg>
          </div>

          <div className={`toggle-group-content ${isOpen ? 'expanded' : 'collapsed'}`}>
            <div className="toggle-group" style={{ paddingTop: '0.5rem' }}>
              {options.map(option =>
                useColourSwatches ? (
                  <ColourTogglePill
                    key={option.id}
                    label={option.label}
                    swatch={option.swatch}
                    active={value === option.id}
                    onClick={() => onChange(option.id)}
                  />
                ) : (
                  <TogglePill
                    key={option.id}
                    label={option.label}
                    active={value === option.id}
                    onClick={() => onChange(option.id)}
                  />
                )
              )}
            </div>
          </div>
        </div>
      );
    }
    
    function CheckboxToggle({ label, checked, onChange }) {
      return (
        <div className="flex items-center justify-between py-4 border-b border-linen-300/50">
          <span className="text-sm text-linen-800">{label}</span>
          <div 
            className={`toggle-checkbox ${checked ? 'active' : ''}`}
            onClick={() => onChange(!checked)}
          />
        </div>
      );
    }

    // Loading dots animation component
    function LoadingDots() {
      const [dots, setDots] = useState('');

      useEffect(() => {
        const interval = setInterval(() => {
          setDots(prev => {
            if (prev === '...') return '';
            return prev + '.';
          });
        }, 400);
        return () => clearInterval(interval);
      }, []);

      return <span className="inline-block w-6 text-left">{dots}</span>;
    }

    // Loading message component with cycling witty messages
    function LoadingMessage() {
      // Start with a random message so users don't always see the same top 3
      const [messageIndex, setMessageIndex] = useState(() =>
        Math.floor(Math.random() * LOADING_MESSAGES.length)
      );
      const [isVisible, setIsVisible] = useState(true);

      useEffect(() => {
        const interval = setInterval(() => {
          setIsVisible(false); // fade out
          setTimeout(() => {
            setMessageIndex(prev => (prev + 1) % LOADING_MESSAGES.length);
            setIsVisible(true); // fade in
          }, 300);
        }, 4000);

        return () => clearInterval(interval);
      }, []);

      return (
        <p className={`text-linen-600 transition-opacity duration-300 ${isVisible ? 'opacity-100' : 'opacity-0'}`}>
          {LOADING_MESSAGES[messageIndex]}
        </p>
      );
    }

    // Rotating headline component with typewriter in and out animation
    function RotatingHeadline() {
      const [currentIndex, setCurrentIndex] = useState(() =>
        Math.floor(Math.random() * HOMEPAGE_HEADLINES.length)
      );
      const [displayedText, setDisplayedText] = useState('');
      const [isTypingIn, setIsTypingIn] = useState(true);
      const typewriterTimeout = useRef(null);
      const holdTimeout = useRef(null);

      useEffect(() => {
        const fullText = HOMEPAGE_HEADLINES[currentIndex];
        let charIndex = 0;

        setDisplayedText('');
        setIsTypingIn(true);

        // Type in phase
        const typeIn = () => {
          if (charIndex < fullText.length) {
            setDisplayedText(fullText.substring(0, charIndex + 1));
            charIndex++;
            const charDelay = 45 + Math.random() * 10; // 45-55ms
            typewriterTimeout.current = setTimeout(typeIn, charDelay);
          } else {
            // Typing in complete - hold phase
            holdTimeout.current = setTimeout(() => {
              // Start typing out
              setIsTypingIn(false);
              typeOut();
            }, 4000); // hold duration
          }
        };

        // Type out phase (reverse)
        const typeOut = () => {
          if (charIndex > 0) {
            charIndex--;
            setDisplayedText(fullText.substring(0, charIndex));
            const charDelay = 25 + Math.random() * 10; // 25-35ms (faster out)
            typewriterTimeout.current = setTimeout(typeOut, charDelay);
          } else {
            // Typing out complete - move to next headline
            setCurrentIndex(prev => (prev + 1) % HOMEPAGE_HEADLINES.length);
          }
        };

        typeIn();

        return () => {
          if (typewriterTimeout.current) clearTimeout(typewriterTimeout.current);
          if (holdTimeout.current) clearTimeout(holdTimeout.current);
        };
      }, [currentIndex]);

      return (
        <h1
          className="font-serif text-5xl md:text-6xl text-linen-900 mb-4 font-medium flex items-center justify-center text-center"
          style={{
            minHeight: '8rem'
          }}
        >
          {displayedText}
        </h1>
      );
    }

    // Configuration summary for results page
    function ConfigSummary({ style, roomType, timeOfDay, colourScheme, flooring }) {
      const getLabelForId = (options, id) => {
        const option = options.find(o => o.id === id);
        return option ? option.label : null;
      };

      const items = [
        { label: 'Style', value: getLabelForId(DESIGN_STYLE_OPTIONS, style) },
        { label: 'Room', value: getLabelForId(ROOM_TYPE_OPTIONS, roomType) },
        { label: 'Lighting', value: getLabelForId(TIME_OF_DAY_OPTIONS, timeOfDay) },
        { label: 'Colours', value: getLabelForId(COLOUR_SCHEME_OPTIONS, colourScheme) },
        { label: 'Flooring', value: getLabelForId(FLOORING_OPTIONS, flooring) },
      ].filter(item => item.value);
      
      if (items.length === 0) return null;
      
      return (
        <div className="mt-6 p-4 card rounded-xl">
          <p className="text-xs text-linen-500 mb-3 uppercase tracking-wide">Applied settings</p>
          <div className="flex flex-wrap gap-2">
            {items.map((item, i) => (
              <span key={i} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-linen-200/50 rounded-full text-sm text-linen-700">
                <span className="text-linen-500">{item.label}:</span>
                <span className="font-medium">{item.value}</span>
              </span>
            ))}
          </div>
        </div>
      );
    }

    function ComparisonSlider({ beforeSrc, afterSrc }) {
      const containerRef = useRef(null);
      const [sliderPosition, setSliderPosition] = useState(50);
      const [isDragging, setIsDragging] = useState(false);
      const [isTouching, setIsTouching] = useState(false);
      const scrollPosition = useRef(0);

      const lockBodyScroll = useCallback(() => {
        // Save current scroll position
        scrollPosition.current = window.pageYOffset || document.documentElement.scrollTop;

        // Lock scroll on body
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.top = `-${scrollPosition.current}px`;
        document.body.style.left = '0';
        document.body.style.right = '0';
        document.body.style.width = '100%';

        // Additional iOS Safari fix
        document.documentElement.style.overflow = 'hidden';
      }, []);

      const unlockBodyScroll = useCallback(() => {
        // Restore scroll
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.left = '';
        document.body.style.right = '';
        document.body.style.width = '';
        document.documentElement.style.overflow = '';

        // Restore scroll position
        window.scrollTo(0, scrollPosition.current);
      }, []);

      const handleMove = useCallback((clientX) => {
        if (!containerRef.current) return;
        const rect = containerRef.current.getBoundingClientRect();
        const x = clientX - rect.left;
        const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
        setSliderPosition(percentage);
      }, []);

      const handleMouseDown = () => setIsDragging(true);
      const handleMouseUp = () => setIsDragging(false);

      const handleMouseMove = useCallback((e) => {
        if (isDragging) handleMove(e.clientX);
      }, [isDragging, handleMove]);

      const handleTouchStart = useCallback((e) => {
        setIsTouching(true);
        lockBodyScroll();
        // Don't prevent default on touchStart to allow other interactions
      }, [lockBodyScroll]);

      const handleTouchMove = useCallback((e) => {
        if (isTouching || e.touches.length > 0) {
          // Prevent default to stop page scrolling
          if (e.cancelable) {
            e.preventDefault();
          }
          e.stopPropagation();
          handleMove(e.touches[0].clientX);
        }
      }, [handleMove, isTouching]);

      const handleTouchEnd = useCallback(() => {
        setIsTouching(false);
        unlockBodyScroll();
      }, [unlockBodyScroll]);

      useEffect(() => {
        document.addEventListener('mouseup', handleMouseUp);
        document.addEventListener('mousemove', handleMouseMove);
        return () => {
          document.removeEventListener('mouseup', handleMouseUp);
          document.removeEventListener('mousemove', handleMouseMove);
        };
      }, [handleMouseMove]);

      // Cleanup body scroll lock on unmount
      useEffect(() => {
        return () => {
          unlockBodyScroll();
        };
      }, [unlockBodyScroll]);

      return (
        <div
          ref={containerRef}
          className="comparison-slider rounded-2xl overflow-hidden card"
          onMouseDown={handleMouseDown}
          onTouchStart={handleTouchStart}
          onTouchMove={handleTouchMove}
          onTouchEnd={handleTouchEnd}
          onTouchCancel={handleTouchEnd}
          onDragStart={(e) => e.preventDefault()}
        >
          <img src={beforeSrc} alt="Before" className="w-full" draggable="false" />

          <div
            className="comparison-after"
            style={{ clipPath: `inset(0 ${100 - sliderPosition}% 0 0)` }}
          >
            <img src={afterSrc} alt="After" className="w-full" draggable="false" />
          </div>

          <div
            className="comparison-handle"
            style={{ left: `${sliderPosition}%`, transform: 'translateX(-50%)' }}
          >
            <div className="comparison-grip">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2c2c2c" strokeWidth="2">
                <path d="M18 8L22 12L18 16" />
                <path d="M6 8L2 12L6 16" />
              </svg>
            </div>
          </div>

          <div className="absolute bottom-4 left-4 bg-linen-900/90 backdrop-blur-sm px-3 py-1.5 rounded-full text-xs font-medium text-linen-100">
            After
          </div>
          <div className="absolute bottom-4 right-4 bg-linen-100/90 backdrop-blur-sm px-3 py-1.5 rounded-full text-xs font-medium text-linen-700">
            Before
          </div>
        </div>
      );
    }

    // Animated textarea component with typewriter placeholder
    function AnimatedTextarea({ value, onChange, label, sublabel }) {
      const [placeholder, setPlaceholder] = useState('');
      const [placeholderOpacity, setPlaceholderOpacity] = useState(1);
      const [currentSuggestionIndex, setCurrentSuggestionIndex] = useState(() =>
        Math.floor(Math.random() * EXTRA_NOTES_PLACEHOLDERS.length)
      );
      const [showHint, setShowHint] = useState(false);
      const [isMobile, setIsMobile] = useState(false);
      const typewriterTimeout = useRef(null);
      const pauseTimeout = useRef(null);
      const fadeTimeout = useRef(null);
      const textareaRef = useRef(null);
      const touchStartX = useRef(0);
      const touchStartY = useRef(0);

      // Detect mobile device
      useEffect(() => {
        const checkMobile = () => {
          setIsMobile(window.innerWidth < 768 || 'ontouchstart' in window);
        };
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // Lock in suggestion function
      const lockInSuggestion = useCallback(() => {
        if (placeholder && !value) {
          onChange({ target: { value: placeholder } });
          setPlaceholder('');
          setShowHint(false);
        }
      }, [placeholder, value, onChange]);

      // Handle Tab key press
      const handleKeyDown = useCallback((e) => {
        if (e.key === 'Tab' && placeholder && !value) {
          e.preventDefault();
          lockInSuggestion();
        }
      }, [placeholder, value, lockInSuggestion]);

      // Handle swipe right on mobile
      const handleTouchStart = useCallback((e) => {
        touchStartX.current = e.touches[0].clientX;
        touchStartY.current = e.touches[0].clientY;
      }, []);

      const handleTouchEnd = useCallback((e) => {
        if (!placeholder || value) return;

        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const deltaX = touchEndX - touchStartX.current;
        const deltaY = Math.abs(touchEndY - touchStartY.current);

        // Swipe right detection (minimum 50px, mostly horizontal)
        if (deltaX > 50 && deltaY < 30) {
          lockInSuggestion();
        }
      }, [placeholder, value, lockInSuggestion]);

      useEffect(() => {
        // Only animate placeholder when textarea is empty
        if (value && value.trim().length > 0) {
          setPlaceholder('');
          setPlaceholderOpacity(1);
          setShowHint(false);
          if (typewriterTimeout.current) clearTimeout(typewriterTimeout.current);
          if (pauseTimeout.current) clearTimeout(pauseTimeout.current);
          if (fadeTimeout.current) clearTimeout(fadeTimeout.current);
          return;
        }

        const currentText = EXTRA_NOTES_PLACEHOLDERS[currentSuggestionIndex];
        let charIndex = 0;

        const typeIn = () => {
          if (charIndex < currentText.length) {
            setPlaceholder(currentText.substring(0, charIndex + 1));
            charIndex++;
            const delay = 15 + Math.random() * 10; // 15-25ms per char (faster)
            typewriterTimeout.current = setTimeout(typeIn, delay);

            // Show hint when typing is halfway done
            if (charIndex === Math.floor(currentText.length / 2)) {
              setShowHint(true);
            }
          } else {
            // Finished typing - brief pause then fade out
            pauseTimeout.current = setTimeout(() => {
              // Fade out
              setPlaceholderOpacity(0);
              setShowHint(false);
              // Wait 40ms after fade, then move to next
              fadeTimeout.current = setTimeout(() => {
                setPlaceholder('');
                setPlaceholderOpacity(1);
                setCurrentSuggestionIndex((prev) => (prev + 1) % EXTRA_NOTES_PLACEHOLDERS.length);
              }, 40);
            }, 2000); // 2 second pause before fade
          }
        };

        // Start typing after a brief delay
        pauseTimeout.current = setTimeout(() => {
          typeIn();
        }, 500);

        return () => {
          if (typewriterTimeout.current) clearTimeout(typewriterTimeout.current);
          if (pauseTimeout.current) clearTimeout(pauseTimeout.current);
          if (fadeTimeout.current) clearTimeout(fadeTimeout.current);
        };
      }, [currentSuggestionIndex, value]);

      return (
        <div className="mb-8 mt-8 relative">
          <label className="block text-sm font-medium text-linen-700 mb-1">
            {label}
          </label>
          {sublabel && (
            <p className="text-xs text-linen-500 mb-3">{sublabel}</p>
          )}
          <div className="relative">
            <textarea
              ref={textareaRef}
              value={value}
              onChange={onChange}
              onKeyDown={handleKeyDown}
              onTouchStart={handleTouchStart}
              onTouchEnd={handleTouchEnd}
              placeholder={placeholder}
              className="input-field resize-none h-28"
              style={{
                '--placeholder-opacity': placeholderOpacity
              }}
            />
            {showHint && placeholder && !value && (
              <div
                className="absolute bottom-3 right-3 text-xs text-linen-400 pointer-events-none transition-opacity duration-300"
                style={{ opacity: showHint ? 0.7 : 0 }}
              >
                {isMobile ? 'swipe right to enter' : 'tab to enter'}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============================================
    // MAIN APP
    // ============================================

    function App() {
      const [step, setStep] = useState(1);
      const [rightmoveUrl, setRightmoveUrl] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState(null);
      const [homepageSubtitle] = useState(() =>
        HOMEPAGE_SUBTITLES[Math.floor(Math.random() * HOMEPAGE_SUBTITLES.length)]
      );
      
      const [propertyInfo, setPropertyInfo] = useState(null);
      const [propertyImages, setPropertyImages] = useState([]);
      const [selectedImage, setSelectedImage] = useState(null);
      
      // Configuration toggles
      const [designStyle, setDesignStyle] = useState(null);
      const [roomType, setRoomType] = useState(null);
      const [timeOfDay, setTimeOfDay] = useState(null);
      const [colourScheme, setColourScheme] = useState(null);
      const [flooring, setFlooring] = useState(null);
      const [activeToggleId, setActiveToggleId] = useState('room');

      // Check if garden/outdoor is selected
      const isOutdoorSpace = roomType === 'garden' || roomType === 'outdoor';

      // Auto-advance to next toggle when a selection is made with stagger
      const handleRoomChange = (value) => {
        setRoomType(value);
        const isOutdoor = value === 'garden' || value === 'outdoor';

        if (value) {
          if (isOutdoor) {
            // For outdoor spaces, close all other toggles
            setTimeout(() => setActiveToggleId(null), 200);
          } else {
            // For indoor spaces, advance to style
            setTimeout(() => {
              setActiveToggleId(null);
              setTimeout(() => setActiveToggleId('style'), 100);
            }, 200);
          }
        }
      };

      const handleStyleChange = (value) => {
        setDesignStyle(value);
        if (value) {
          setTimeout(() => {
            setActiveToggleId(null);
            setTimeout(() => setActiveToggleId('time'), 100);
          }, 200);
        }
      };

      const handleTimeChange = (value) => {
        setTimeOfDay(value);
        if (value) {
          setTimeout(() => {
            setActiveToggleId(null);
            setTimeout(() => setActiveToggleId('colour'), 100);
          }, 200);
        }
      };

      const handleColourChange = (value) => {
        setColourScheme(value);
        if (value) {
          setTimeout(() => {
            setActiveToggleId(null);
            setTimeout(() => setActiveToggleId('floor'), 100);
          }, 200);
        }
      };

      const handleFloorChange = (value) => {
        setFlooring(value);
        if (value) {
          setTimeout(() => setActiveToggleId(null), 200);
        }
      };
      const [extraNotes, setExtraNotes] = useState('');
      const [autoDownload, setAutoDownload] = useState(false);
      
      const [generatedResult, setGeneratedResult] = useState(null);

      const fetchPropertyImages = async (url) => {
        setIsLoading(true);
        setError(null);

        try {
          const response = await fetch(`${API_BASE_URL}/property`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });

          if (!response.ok) {
            const errorText = await response.text();
            try {
              const errorData = JSON.parse(errorText);
              throw new Error(errorData.detail || "That link's not quite right. Try a Rightmove property URL.");
            } catch (e) {
              throw new Error("That link's not quite right. Try a Rightmove property URL.");
            }
          }

          const data = await response.json();
          
          setPropertyInfo({
            address: data.address,
            price: data.price,
            bedrooms: data.bedrooms,
            bathrooms: data.bathrooms,
            propertyType: data.property_type
          });
          
          const imagePromises = data.images.map(async (img) => {
            const originalUrl = img.url_high_res || img.url;
            try {
              const proxyResponse = await fetch(`${API_BASE_URL}/proxy-image?url=${encodeURIComponent(originalUrl)}`);

              if (!proxyResponse.ok) {
                console.warn(`Failed to proxy image ${img.id}: HTTP ${proxyResponse.status}`);
                return null; // Skip failed images gracefully
              }

              const proxyData = await proxyResponse.json();

              if (!proxyData.data_url) {
                console.warn(`No data_url returned for image ${img.id}`);
                return null;
              }

              return {
                id: img.id,
                url: proxyData.data_url,
                originalUrl: originalUrl,
                room: img.room,
                caption: img.caption || ''
              };
            } catch (err) {
              console.error(`Error fetching image ${img.id}:`, err);
              return null; // Skip failed images instead of crashing
            }
          });

          const images = (await Promise.all(imagePromises)).filter(img => img && img.url);

          if (images.length === 0) {
            throw new Error('No images could be loaded. The property images may be unavailable or the proxy server may be experiencing issues.');
          }

          setPropertyImages(images);
          setIsLoading(false);
          setStep(2);
          window.scrollTo(0, 0);

        } catch (err) {
          setError(err.message);
          setIsLoading(false);
        }
      };

      const handleImageSelect = (image) => {
        setSelectedImage(image);
        setActiveToggleId('room'); // Start with Room Type open
        setStep(3);
        window.scrollTo(0, 0);
      };

      const generateRenovation = async () => {
        if (!selectedImage) return;

        setIsLoading(true);
        setError(null);
        setStep(4);
        window.scrollTo(0, 0);

        try {
          const response = await fetch(`${API_BASE_URL}/renovate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image_url: selectedImage.originalUrl,
              style: designStyle,
              room_type: roomType,
              time_of_day: timeOfDay,
              colour_scheme: colourScheme,
              flooring: flooring,
              extra_notes: extraNotes || null,
              auto_download: autoDownload
            })
          });

          if (!response.ok) {
            const errorText = await response.text();
            try {
              const errorData = JSON.parse(errorText);
              throw new Error(errorData.detail || 'Generation failed — please try again.');
            } catch (e) {
              throw new Error('Generation failed — please try again.');
            }
          }

          const data = await response.json();
          
          const result = {
            before: selectedImage.url,
            after: `data:image/jpeg;base64,${data.generated_image_base64}`,
            style: designStyle,
            roomType: roomType
          };
          
          setGeneratedResult(result);
          
          if (autoDownload && data.generated_image_base64) {
            const link = document.createElement('a');
            link.href = `data:image/jpeg;base64,${data.generated_image_base64}`;
            link.download = `renovision-${roomType || 'room'}-${designStyle || 'styled'}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
          
          setIsLoading(false);
          
        } catch (err) {
          setError(err.message);
          setIsLoading(false);
        }
      };

      const resetApp = () => {
        setStep(1);
        setRightmoveUrl('');
        setPropertyInfo(null);
        setPropertyImages([]);
        setSelectedImage(null);
        setDesignStyle(null);
        setRoomType(null);
        setTimeOfDay(null);
        setColourScheme(null);
        setFlooring(null);
        setExtraNotes('');
        setAutoDownload(false);
        setGeneratedResult(null);
        setError(null);
      };

      const goBackToSelection = () => {
        setSelectedImage(null);
        setDesignStyle(null);
        setRoomType(null);
        setTimeOfDay(null);
        setColourScheme(null);
        setFlooring(null);
        setExtraNotes('');
        setError(null);
        setStep(2);
      };

      return (
        <div className="min-h-screen">
          {/* Header */}
          <header className="bg-linen-100/80 backdrop-blur-sm border-b border-linen-300/30 py-4 px-6 sticky top-0 z-50">
            <div className="max-w-5xl mx-auto flex items-center justify-between">
              <div className="flex items-center gap-3">
                <img
                  src={LOGO_URL}
                  alt="Renovision"
                  className="logo-img cursor-pointer transition-opacity hover:opacity-70"
                  onClick={resetApp}
                  onError={(e) => { e.target.style.display = 'none'; }}
                />
              </div>

              {step > 1 && (
                <button onClick={resetApp} className="btn-secondary text-sm py-2 px-4">
                  Start Over
                </button>
              )}
            </div>
          </header>

          <main className="max-w-5xl mx-auto px-6 py-12">
            
            {/* Step 1: URL Input */}
            {step === 1 && (
              <div className="max-w-xl mx-auto text-center fade-in">
                <RotatingHeadline />
                <p className="text-linen-600 text-lg mb-10 font-light">
                  {homepageSubtitle}
                </p>

                <div className="card rounded-2xl p-8">
                  <label className="block text-left text-sm font-medium mb-3 text-linen-700">
                    Rightmove URL
                  </label>
                  <div className="flex flex-col sm:flex-row gap-3">
                    <input
                      type="url"
                      value={rightmoveUrl}
                      onChange={(e) => setRightmoveUrl(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' && rightmoveUrl && !isLoading) {
                          fetchPropertyImages(rightmoveUrl);
                        }
                      }}
                      placeholder="https://www.rightmove.co.uk/properties/..."
                      className="input-field flex-1"
                    />
                    <button
                      onClick={() => fetchPropertyImages(rightmoveUrl)}
                      disabled={!rightmoveUrl || isLoading}
                      className="btn-primary whitespace-nowrap"
                    >
                      {isLoading ? (
                        <span className="flex items-center gap-2">
                          <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                          </svg>
                          Loading
                        </span>
                      ) : 'Fetch Property'}
                    </button>
                  </div>
                  
                  {error && (
                    <p className="text-red-600 text-sm mt-4 text-left">{error}</p>
                  )}
                </div>
              </div>
            )}

            {/* Step 2: Image Selection */}
            {step === 2 && (
              <div className="fade-in">
                {propertyInfo && (
                  <div className="card rounded-2xl p-6 mb-8 max-w-lg mx-auto text-center">
                    <h2 className="font-serif text-2xl text-linen-900 mb-2">{propertyInfo.address}</h2>
                    <div className="flex flex-wrap justify-center gap-3 text-linen-600 text-sm">
                      <span className="font-medium text-linen-800">{propertyInfo.price}</span>
                      {propertyInfo.bedrooms > 0 && <span>{propertyInfo.bedrooms} bed</span>}
                      {propertyInfo.bathrooms > 0 && <span>{propertyInfo.bathrooms} bath</span>}
                    </div>
                  </div>
                )}
                
                <div className="text-center mb-8">
                  <h2 className="font-serif text-3xl md:text-4xl text-linen-900 mb-2">Choose a room</h2>
                  <p className="text-linen-600">Click any image to configure your renovation.</p>
                </div>
                
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  {propertyImages.map((image) => (
                    <div
                      key={image.id}
                      onClick={() => handleImageSelect(image)}
                      className="image-card rounded-xl overflow-hidden card-hover aspect-[4/3]"
                    >
                      <img
                        src={image.url}
                        alt="Property image"
                        className="w-full h-full object-cover"
                      />
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Step 3: Configure */}
            {step === 3 && selectedImage && (
              <div className="fade-in">
                <button 
                  onClick={goBackToSelection}
                  className="flex items-center gap-2 text-linen-600 hover:text-linen-800 mb-6 transition-colors"
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                  Back to images
                </button>
                
                <div className="grid lg:grid-cols-2 gap-10">
                  <div className="lg:sticky lg:top-24 lg:self-start">
                    <div className="card rounded-2xl overflow-hidden">
                      <img 
                        src={selectedImage.url} 
                        alt="Selected room"
                        className="w-full"
                      />
                    </div>
                  </div>
                  
                  <div>
                    <h2 className="font-serif text-3xl text-linen-900 mb-2">Configure your renovation</h2>
                    <p className="text-linen-600 mb-8">Options, like dinner guests, may be politely ignored.</p>

                    <AccordionToggleGroup
                      label="Room Type"
                      options={ROOM_TYPE_OPTIONS}
                      value={roomType}
                      onChange={handleRoomChange}
                      isOpen={activeToggleId === 'room'}
                      onToggle={() => setActiveToggleId(activeToggleId === 'room' ? null : 'room')}
                    />

                    {!isOutdoorSpace && (
                      <>
                        <AccordionToggleGroup
                          label="Interior Design Style"
                          options={DESIGN_STYLE_OPTIONS}
                          value={designStyle}
                          onChange={handleStyleChange}
                          isOpen={activeToggleId === 'style'}
                          onToggle={() => setActiveToggleId(activeToggleId === 'style' ? null : 'style')}
                        />

                        <AccordionToggleGroup
                          label="Time of Day"
                          options={TIME_OF_DAY_OPTIONS}
                          value={timeOfDay}
                          onChange={handleTimeChange}
                          isOpen={activeToggleId === 'time'}
                          onToggle={() => setActiveToggleId(activeToggleId === 'time' ? null : 'time')}
                        />

                        <AccordionToggleGroup
                          label="Colour Scheme"
                          options={COLOUR_SCHEME_OPTIONS}
                          value={colourScheme}
                          onChange={handleColourChange}
                          isOpen={activeToggleId === 'colour'}
                          onToggle={() => setActiveToggleId(activeToggleId === 'colour' ? null : 'colour')}
                          useColourSwatches={true}
                        />

                        <AccordionToggleGroup
                          label="Flooring"
                          options={FLOORING_OPTIONS}
                          value={flooring}
                          onChange={handleFloorChange}
                          isOpen={activeToggleId === 'floor'}
                          onToggle={() => setActiveToggleId(activeToggleId === 'floor' ? null : 'floor')}
                        />
                      </>
                    )}
                    
                    <AnimatedTextarea
                      value={extraNotes}
                      onChange={(e) => setExtraNotes(e.target.value)}
                      label="Extra Notes"
                      sublabel="Be as specific as you like"
                    />
                    
                    <CheckboxToggle
                      label="Auto-download generated image"
                      checked={autoDownload}
                      onChange={setAutoDownload}
                    />
                    
                    <div className="mt-10">
                      <button
                        onClick={generateRenovation}
                        className="btn-primary w-full text-lg py-4"
                      >
                        Generate Renovation
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Step 4: Result */}
            {step === 4 && (
              <div className="fade-in">
                <div className="text-center mb-10">
                  <h2 className="font-serif text-3xl md:text-4xl text-linen-900 mb-2">
                    {isLoading ? (<>Creating your vision<LoadingDots /></>) : 'Your renovation'}
                  </h2>
                  <p className="text-linen-600">
                    {isLoading
                      ? 'This usually takes around 15 seconds.'
                      : 'Drag the slider to compare before and after.'}
                  </p>
                </div>

                {isLoading ? (
                  <div className="max-w-2xl mx-auto">
                    <div className="card rounded-2xl aspect-[4/3] flex items-center justify-center">
                      <div className="text-center">
                        <svg className="rotating-blob w-12 h-12 mx-auto mb-4" viewBox="0 0 100 100" fill="none">
                          <path
                            d="M50,10 C60,8 75,12 85,25 C92,35 95,48 90,62 C85,75 72,85 58,88 C45,91 30,88 20,78 C10,68 5,52 8,38 C11,24 25,12 40,10 Z"
                            fill="#6b655c"
                            opacity="0.3"
                          />
                          <path
                            d="M50,20 C58,18 68,22 75,32 C80,40 82,50 78,60 C74,69 65,76 55,78 C46,80 35,77 28,70 C21,63 18,52 20,42 C22,32 32,22 42,20 Z"
                            fill="#a89f93"
                          />
                        </svg>
                        <LoadingMessage />
                      </div>
                    </div>
                  </div>
                ) : error ? (
                  <div className="max-w-lg mx-auto text-center">
                    <div className="card rounded-2xl p-8">
                      <p className="text-red-600 mb-4">Even masterpieces hit snags. Give it another go?</p>
                      <button onClick={goBackToSelection} className="btn-secondary">
                        Try Again
                      </button>
                    </div>
                  </div>
                ) : generatedResult && (
                  <div className="max-w-3xl mx-auto">
                    <ComparisonSlider
                      beforeSrc={generatedResult.before}
                      afterSrc={generatedResult.after}
                    />
                    
                    <ConfigSummary
                      style={designStyle}
                      roomType={roomType}
                      timeOfDay={timeOfDay}
                      colourScheme={colourScheme}
                      flooring={flooring}
                    />
                    
                    <div className="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                      <button
                        onClick={() => {
                          const link = document.createElement('a');
                          link.href = generatedResult.after;
                          link.download = `renovision-${generatedResult.roomType || 'room'}-${generatedResult.style || 'styled'}.jpg`;
                          document.body.appendChild(link);
                          link.click();
                          document.body.removeChild(link);
                        }}
                        className="btn-primary"
                      >
                        Download Image
                      </button>
                      <button onClick={goBackToSelection} className="btn-secondary">
                        Try Another Room
                      </button>
                      <button onClick={resetApp} className="btn-secondary">
                        New Property
                      </button>
                    </div>
                  </div>
                )}
              </div>
            )}
          </main>

          <footer className="border-t border-linen-300/30 py-8 px-6 mt-16">
            <div className="max-w-5xl mx-auto text-center text-sm text-linen-500">
              <p className="flex flex-col items-center gap-1">
                <span>Powered by cutting-edge generative models.</span>
                <span>Designed & built by Wallcache Studios.</span>
              </p>
            </div>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
